<html>
<title>Whiplash450's Dark Heresy 2.0 Character Creator</title>
<head>
<meta name="description" content="Whiplash450's Dark Heresy 2nd Edition Character Creator">
<meta name="keywords" content="Dark, Heresy, 2nd, Edition, 2.0, Character, Creator, Generator">
<meta name="author" content="Whiplash450">
<link rel="alternate" href="http://heresycreator.96.lt" hreflang="en" />
<link rel="icon" 
      type="image/ico" 
      href="http://heresycreator.96.lt/favicon.ico" />
<link href="../bootstrap/bootstrap.min.css" rel="stylesheet">
<script src="http://code.jquery.com/jquery-2.1.1.min.js"></script>
<script src="../bootstrap/bootstrap.min.js"></script>
<script src="http://heresycreator.96.lt/nameArrays.js"></script>
<script src="/descArrays.js"></script>

<script src="http://heresycreator.96.lt/jspdf.min.js"></script>
<script src="http://heresycreator.96.lt/adler32cs.js"></script>
<script src="http://heresycreator.96.lt/FileSaver.min.js"></script>
<script src="http://heresycreator.96.lt/BlobBuilder.min.js"></script>
<script src="http://heresycreator.96.lt/jspdf.plugin.addimage.js"></script>
<script src="http://heresycreator.96.lt/jspdf.plugin.standard_fonts_metrics.js"></script>
<script src="http://heresycreator.96.lt/jspdf.plugin.split_text_to_size.js"></script>
</head>

<body>
<br />
<div class="panel panel-default" style="display: block; width: 1140px; margin-left: 15px;">
  <div class="panel-body">
    <img src="http://heresycreator.96.lt/DH-logo_small.PNG" style="margin-top: -5px; width: 40px; display: inline;"/>&emsp;
    <h1 style="display: inline; vertical-align: middle;">&emsp;Whiplash450's Dark Heresy 2nd Edition Character Creator&emsp;</h1>
    <img src="http://heresycreator.96.lt/DH-logo_small.PNG" style="margin-top: -5px; width: 40px;"/>
  </div>
</div>
<hr style="width: 100%; height: 1px;" NOSHADE/>
&emsp;&emsp;<h3 style="display: inline">Save / Load Character</h3>&emsp;<i style="margin-top: -10px; color: red">(Coming Soon!)</i>
&emsp;&emsp;<button id="button_save" class="btn btn-sm btn-success" style="display: inline; margin-top: -10px;">Save Character</button>&emsp;<i>*Need at least a name to save!</i>
&emsp;&emsp;<button id="button_load" class="btn btn-sm btn-primary" style="display: inline; margin-top: -10px;" disabled>Load Character</button>

<hr style="width: 100%; height: 1px;" NOSHADE/>
<!-- &emsp;<h3 style="display: inline">Choose Printing Type:&emsp;</h3>
DH 2.0 PC Sheet&emsp;<input id="radio_print_sheet" checked="checked" name="printtype" value="sheet" type="radio" style="width: 20px; height: 20px;"/>&emsp;&emsp;
Plain&emsp;<input id="radio_print_plain" name="printtype" value="plain" disabled type="radio" style="width: 20px; height: 20px;"/>&emsp;&emsp; -->
&emsp;<button id="button_testpdf" class="btn btn-danger" style="margin-top: -10px;">Print Character Sheet</button>&emsp;
<br><br>
&emsp;<h3 style="display: inline">1. Choose Gender:</h3>
	&emsp;Male&nbsp;&nbsp;<input id="radio_gender_male" checked="checked" name="gender" value="male" type="radio" style="width: 20px; height: 20px;"/>
	&emsp;Female&nbsp;&nbsp;<input id="radio_gender_female" name="gender" value="female" type="radio" style="width: 20px; height: 20px;"/>

&emsp;&emsp;&emsp;<h3 style="display: inline">2. Choose Name:</h3>&emsp;&emsp;<input id="box_name" class="form-control" style="display: inline; width: 200px;"/>
&emsp;<button id="button_namegenerate" class="btn btn-sm btn-primary">Generate&nbsp;&nbsp;<i class="glyphicon glyphicon-repeat"></i></button>
&emsp;<h3 id="nameError" style="color: red; display: inline;">Pick a gender first!</h3>
<br/><br/>
&emsp;<h3 style="display: inline">3. Choose Homeworld:</h3>&emsp;&emsp;
<select id="select_world" class="form-control" style="width: 500px; display: inline;">
  <option disabled selected >Select Homeworld</option>
  <option value="0">Feral World (+S, +T, -infl -- Wounds: 9 -- Fate: 2 -- Aptitude: T)</option>
  <option value="1">Forge World (+T, +Int, -fel -- Wounds: 8 -- Fate: 3 -- Aptitude: Int)</option>
  <option value="2">Highborn World (+Fel, +Infl, -T -- Wounds: 9 -- Fate: 4 -- Aptitude: Fel)</option>
  <option value="3">Hive World (+Ag, +Per, -WP -- Wounds: 8 -- Fate: 2 -- Aptitude: Per)</option>
  <option value="4">Shrine World (+WP, +Fel, -Per -- Wounds: 7 -- Fate: 3 -- Aptitude: WP)</option>
  <option value="5">Voidborn (+Int, +WP, -S -- Wounds: 7 -- Fate: 3 -- Aptitude: Int)</option>
  <option disabled>---- New Homeworlds (Not quite ready yet!) ----</option>
  <option disabled value="6">Agri World (+S, +T, -infl -- Wounds: 9 -- Fate: 2 -- Aptitude: T)</option>
  <option disabled value="7">Feudal World</option>
  <option disabled value="8">Frontier World</option>
  <option disabled value="9">Death World</option>
  <option disabled value="10">Garden World</option>
  <option disabled value="11">Research Station</option>
  <option disabled value="12">Daemon World</option>
  <option disabled value="13">Penal Colony</option>
  <option disabled value="14">Quarantine World (+BS, +Int, -S -- Wounds: 8 -- Fate: 3 -- Aptitude: Fieldcraft)</option>
</select>
<br/><br/>&emsp;&emsp;&emsp;<i>** Homeworld sets Favoured/Unfavoured stats, number of wounds, number of fate points and first Aptitude.</i>
<br/><br/>
&emsp;<h3 style="display: inline">4. Choose Background (& Background Aptitude):</h3>&emsp;&emsp;
<select id="select_background" class="form-control" style="display: inline; width: 250px;">
  <option disabled selected >Select Background</option>
</select>
&emsp;&emsp;<div id="div_bg_aptitude" style="display: inline;"></div>
<br/><br/>
&emsp;<h3 style="display: inline">5. Choose Role:</h3>&emsp;&emsp;
<select id="select_roles" class="form-control" style="display: inline; width: 210px;">
  <option disabled selected>Select Background First!</option>
</select>
&emsp;&emsp;<i>** Denotes recommendation from your Background choice. This is due to linking Aptitudes to the Skills & Talents from Roles</i>
<br/><br/>
<div class="well" style="margin-left: 10px; width: 99%;">
  <div class="container-fluid">
    <div class="row">
      <div class="col-md-3">
        <table class="table table-hover table-bordered">
          <thead>
            <tr>
              <th>Background Skills</th>
            </tr>
          </thead>
          <tbody id="tbody_startingskills">  
          </tbody>
        </table>
      </div>
      <div class="col-md-3">
        <table class="table table-hover table-bordered">
          <thead>
            <tr>
              <th>Homeworld Talents</th>
            </tr>
          </thead>
          <tbody id="tbody_worldtalents">
          </tbody>
        </table>
        <br>
        <table class="table table-hover table-bordered">
          <thead>
            <tr>
              <th>Background Talents</th>
            </tr>
          </thead>
          <tbody id="tbody_startingtalents">  
          </tbody>
        </table>
        <br>
        <table class="table table-hover table-bordered">
          <thead>
            <tr>
              <th>Role Talents</th>
            </tr>
          </thead>
          <tbody id="tbody_roletalents">  
          </tbody>
        </table>
        <br>
        <table class="table table-hover table-bordered">
          <thead>
            <tr>
              <th>Divination <i style="font-weight: normal; font-size: small;">(Hover for full desc.)</i>
              <button id="button_divination_pick" disabled class="btn btn-xs btn-success" style="float: right;">Pick</button><i style="float: right;">&emsp;</i>
              <button id="button_divination_reroll" disabled class="btn btn-xs btn-primary" style="float: right;">Re-roll</button></th>
            </tr>
          </thead>
          <tbody id="tbody_divination">  
          </tbody>
        </table>        
      </div>
      <div class="col-md-3">
        <table class="table table-hover table-bordered">
          <thead>
            <tr>
              <th>Starting Equipment</th>
            </tr>
          </thead>
          <tbody id="tbody_startingequip">  
          </tbody>
        </table>
      </div>
      <div class="col-md-3">
        <table class="table table-hover table-bordered">
          <thead>
            <tr>
              <th>Homeworld Bonus <i style="font-weight: normal; font-size: small;">(Hover for full desc.)</i></th>
            </tr>
          </thead>
          <tbody id="tbody_startingworldbonus">  
          </tbody>
        </table>
        <br>
        <table class="table table-hover table-bordered">
          <thead>
            <tr>
              <th>Background Bonus <i style="font-weight: normal; font-size: small;">(Hover for full desc.)</i></th>
            </tr>
          </thead>
          <tbody id="tbody_startingbgbonus">  
          </tbody>
        </table>
        <br>
        <table class="table table-hover table-bordered">
          <thead>
            <tr>
              <th>Role Bonus <i style="font-weight: normal; font-size: small;">(Hover for full desc.)</i></th>
            </tr>
          </thead>
          <tbody id="tbody_rolebonus">
          </tbody>
        </table>
      </div>
      <!-- <div class="col-md-2">
        <table class="table table-hover table-bordered">
          <thead>
            <tr>
              <th>Recommended Roles</th>
            </tr>
          </thead>
          <tbody id="tbody_recroles">  
          </tbody>
        </table>
      </div> -->
    </div>
  </div>
</div>
&emsp;<h3 style="display: inline">6. Aptitudes:</h3>&emsp;&emsp;<i>** Aptitudes are prerequisites for, and give an exp discount when buying levels in, certain Skills & Talents.</i>
<br/><br/>
<table  class="table table-hover table-bordered" style="margin-left: 100px; max-width: 700px;">
	<thead>
		<tr>
			<th style="max-width: 100px;">Source</th>
			<th style="max-width: 250px;">Aptitude</th>
		</tr>
	</thead>
	<tbody>
		<tr>
			<td>Homeworld</td>
			<td id="aptitude_td_world"></td>
		</tr>
	</tbody>
	<tbody>
		<tr>
			<td>Background</td>
			<td id="aptitude_bg"></td>
		</tr>
	</tbody>
	<tbody >
		<tr>
			<td>Role</td>
			<td id="tr_role_aptitude_1"></td>
			<td id="tr_role_aptitude_1_clash" style="display: none; color: red;">Clash! Take another Stat Aptitude Instead</td>			
		</tr>
	</tbody>
	<tbody id="tbody_roleaptitudes"></tbody>
</table>
<div class="container-fluid">
  <div class="row">
    <div class="col-md-6">
      &emsp;<h3 style="display: inline">7. Character Stats</h3>&emsp;&emsp;
      <button id="button_reroll" class="btn btn-success btn-sm" style="margin-top: -10px;" disabled >Re-roll</button>
      &emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;
      &emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;
      <button id="button_recalc" disabled class="btn btn-warning btn-sm">Re-Calc after Manual Roll Edit</button>
      <br/><br/>
      &emsp;<label>Starting Base points for Stats:</label>&emsp;&emsp;
      <input id="input_basepoints" class="form-control" style="width: 50px; display: inline" value="20"/>&emsp;
      <button id="button_applybasepoints" disabled class="btn btn-sm btn-primary">Apply + ReCalc</button>
      <br/><br/>
      <table class="table table-hover table-bordered" style="margin-left: 10px; width: 100%;">
        <thead>
          <tr>
            <th>Stat</th>
            <th>Base</th>
            <th>Roll #1 (1d10)</th>
            <th>Roll #2 (1d10)</th>
            <th>Total</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>Weapon Skill (WS)</td>
            <td><input id="box_stat_ws_base" style="width: 35px;" value="20" disabled /></td>
            <td><input id="box_stat_ws_roll1" style="width: 35px;"/></td>
            <td><input id="box_stat_ws_roll2" style="width: 35px;"/></td>
            <td><input id="box_stat_ws_total" style="width: 35px;" disabled /></td>
          </tr>
          <tr>
            <td>Ballistic Skill (BS)</td>
            <td><input id="box_stat_bs_base" style="width: 35px;" value="20" disabled /></td>
            <td><input id="box_stat_bs_roll1" style="width: 35px;"/></td>
            <td><input id="box_stat_bs_roll2" style="width: 35px;"/></td>
            <td><input id="box_stat_bs_total" style="width: 35px;" disabled /></td>
          </tr>
          <tr>
            <td>Strength (S)</td>
            <td><input id="box_stat_s_base" style="width: 35px;" value="20" disabled /></td>
            <td><input id="box_stat_s_roll1" style="width: 35px;"/></td>
            <td><input id="box_stat_s_roll2" style="width: 35px;"/></td>
            <td><input id="box_stat_s_total" style="width: 35px;" disabled /></td>
          </tr>
          <tr>
            <td>Toughness (T)</td>
            <td><input id="box_stat_t_base" style="width: 35px;" value="20" disabled /></td>
            <td><input id="box_stat_t_roll1" style="width: 35px;"/></td>
            <td><input id="box_stat_t_roll2" style="width: 35px;"/></td>
            <td><input id="box_stat_t_total" style="width: 35px;" disabled /></td>
          </tr>
          <tr>
            <td>Agility (Ag)</td>
            <td><input id="box_stat_ag_base" style="width: 35px;" value="20" disabled /></td>
            <td><input id="box_stat_ag_roll1" style="width: 35px;"/></td>
            <td><input id="box_stat_ag_roll2" style="width: 35px;"/></td>
            <td><input id="box_stat_ag_total" style="width: 35px;" disabled /></td>
          </tr>
          <tr>
            <td>Intelligence (Int)</td>
            <td><input id="box_stat_int_base" style="width: 35px;" value="20" disabled /></td>
            <td><input id="box_stat_int_roll1" style="width: 35px;"/></td>
            <td><input id="box_stat_int_roll2" style="width: 35px;"/></td>
            <td><input id="box_stat_int_total" style="width: 35px;" disabled /></td>
          </tr>
          <tr>
            <td>Perception (Per)</td>
            <td><input id="box_stat_per_base" style="width: 35px;" value="20" disabled /></td>
            <td><input id="box_stat_per_roll1" style="width: 35px;"/></td>
            <td><input id="box_stat_per_roll2" style="width: 35px;"/></td>
            <td><input id="box_stat_per_total" style="width: 35px;" disabled /></td>
          </tr>
          <tr>
            <td>Willpower (WP)</td>
            <td><input id="box_stat_wp_base" style="width: 35px;" value="20" disabled /></td>
            <td><input id="box_stat_wp_roll1" style="width: 35px;"/></td>
            <td><input id="box_stat_wp_roll2" style="width: 35px;"/></td>
            <td><input id="box_stat_wp_total" style="width: 35px;" disabled /></td>
          </tr>
          <tr>
            <td>Fellowship (Fel)</td>
            <td><input id="box_stat_fel_base" style="width: 35px;" value="20" disabled /></td>
            <td><input id="box_stat_fel_roll1" style="width: 35px;"/></td>
            <td><input id="box_stat_fel_roll2" style="width: 35px;"/></td>
            <td><input id="box_stat_fel_total" style="width: 35px;" disabled /></td>
          </tr>
          <tr>
            <td>Influence (Infl)</td>
            <td><input id="box_stat_infl_base" style="width: 35px;" value="20" disabled /></td>
            <td><input id="box_stat_infl_roll1" style="width: 35px;"/></td>
            <td><input id="box_stat_infl_roll2" style="width: 35px;"/></td>
            <td><input id="box_stat_infl_total" style="width: 35px;" disabled /></td>
          </tr>
          <tr>
            <td>Wounds</td>
            <td><input id="box_stat_wounds_base" style="width: 35px;" value="" disabled /></td>
            <td><input id="box_stat_wounds_roll1" style="width: 35px;"/>&emsp;<label>(1d5)</label></td>
            <td></td>
            <td><input id="box_stat_wounds_total" style="width: 35px;" disabled /></td>
          </tr>
          <tr>
            <td id="fate_title">Fate Points</td>
            <td><input id="box_stat_fate_base" style="width: 35px;" value="" disabled /></td>
            <td><input id="box_stat_fate_roll1" style="width: 35px;"/><label id="fate_result"></label></td>
            <td></td>
            <td><input id="box_stat_fate_total" style="width: 35px;" disabled /></td>
          </tr>
        </tbody>
      </table>
    </div>
    <div class="col-md-6">
    &emsp;<h3 style="display: inline">8. Trait Picker</h3>
    <br/><br/><i>*Traits cannot be purchased directly by spending experience points
and are primarily an aspect that NPCs possess. They might be granted by certain Talents, Elite Advances(e.g Psyker) or by your GM directly (either as a reward/punishment).</i>
    <br/><br/>
    <table class="table table-hover table-bordered" style="margin-left: 0px;">
      <thead>
        <tr>
          <th>Trait <i style="font-weight: normal; font-size: small;">(Hover for full desc.)</i></th>
          <th style="width: 30px;"></th>
          <th>Trait <i style="font-weight: normal; font-size: small;">(Hover for full desc.)</i></th>
          <th></th>
        </tr>
      </thead>
      <tbody id="tbody_traits">        
      </tbody>
    </table>
    </div>
  </div>
</div>

<br/><br/>
&emsp;<h3 style="display: inline">9. Skill Picker</h3>&emsp;<i id="skill_prereq">(Select World, Background & Role first)</i>
<br/><br/>
<div id="div_skillPicker" style="display: none;">
  &emsp;&emsp;<label>Pick a Skill (Skill Aptitudes):</label>&emsp;</label>
  <select id="select_skills" class="form-control" style="width: 350px; display: inline;">
    <option disabled selected>Select a Skill</option>
  </select>
  &emsp;
  <button id="button_addskill" disabled class="btn btn-success btn-sm">Add Skill</button>
  <!-- &emsp;** &#10013;<i> - Denotes a Specialist Skill</i> -->
  <br/><br/>
  &emsp;&emsp;<label>Remaining Exp: </label>&emsp;<input id="input_exp" class="form-control" value="1000" style="display: inline; width: 90px;" />&emsp;
  <i>** Experience is shared between Skills, Stat Advances <b>and</b> Talents. Choose wisely!</i>
  <div id="div_noxperror" style="display: none;">
    <h3 style="color: red">&emsp;&emsp;** NOT ENOUGH XP LEFT FOR UPGRADE **</h3>
  </div>
  <br/><br/>
  <table class="table table-hover table-bordered" style="margin-left: 50px; width: 60%;">
    <thead>
      <tr>
        <th>Skill Name</th>
        <th style="max-width: 150px;"># of Matching Aptitudes</th>
        <th>Known</th>
        <th>Trained</th>
        <th>Experienced</th>
        <th>Expert</th>
        <th></th>
      </tr>
    </thead>
    <tbody id="tbody_skills">
    </tbody>
  </table>
</div>
<br/><br/>
&emsp;<h3 style="display: inline">10. Character Stat Picker</h3>&emsp;<i id="stat_prereq">(Select World, Background & Role first)</i>
<br/><br/>
<div id="div_statPicker" style="display: none;">
  &emsp;&emsp;<label>Pick a Stat (Stat Aptitudes):</label>&emsp;</label>
  <select id="select_stats" class="form-control" style="width: 300px; display: inline;">
    <option disabled selected>Select a Stat</option>
  </select>
  &emsp;
  <button id="button_addstat" disabled class="btn btn-success btn-sm">Add Stat</button>
  <br/><br/>
  <div id="div_noxperror_stat" style="display: none;">
    <h3 style="color: red">&emsp;&emsp;** NOT ENOUGH XP LEFT FOR UPGRADE **</h3>
  </div>
  <br/><br/>
  <table class="table table-hover table-bordered" style="margin-left: 50px; width: 60%;">
    <thead>
      <tr>
        <th>Stat Name</th>
        <th style="max-width: 150px;"># of Matching Aptitudes</th>
        <th>Simple</th>
        <th>Intermediate</th>
        <th>Trained</th>
        <th>Proficient</th>
        <th>Expert</th>
        <th></th>
      </tr>
    </thead>
    <tbody id="tbody_stats">
    </tbody>
  </table>
</div>
<br/><br/>
&emsp;<h3 style="display: inline">11. Talent Picker</h3>&emsp;<i style="color: red;">(Work in progress)</i>
<br/><br/>
<div id="div_talentpicker" style="display: none;">
  &emsp;&emsp;<label>Pick a Tier 1 Talent:</label>&emsp;</label>
  <select id="select_talent_1" style="width: 150px;">
    <option disabled selected>Select a Talent</option>
  </select>
  &emsp;
  <button id="button_addtalent_1" class="btn btn-success btn-sm">Add Talent</button>
  &emsp;** &#10013;<i> - Denotes a Specialist Talent</i>
  <br/><br/>
  <table class="table table-hover table-bordered" style="margin-left: 50px; width: 50%;">
    <thead>
      <tr>
        <th>Talent Name</th>        
        <th># of Matching Aptitudes</th>
        <th>Talent Cost</th>
        <th>Prerequisites</th>
        <th>Talent Description</th>
        <th></th>
      </tr>
    </thead>
    <tbody id="tbody_talents_1">
    </tbody>
  </table>
</div>
<br/><br/><br/><br/>

<!-- DIVINATION Modal -->
<div class="modal fade" id="modal_divination" tabindex="-1" role="dialog" aria-labelledby="modal_divination_Label" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
        <h4 class="modal-title" id="modal_divination_Label">Pick Divination</h4>
      </div>
      <div class="modal-body">
        <select id="select_divination" class="form-control" style="width: 400px;">
          <option disabled selected>Select a Divination</option>
        </select>
        <br>
        <label>Description</label>
        <br>
        <textarea id="textarea_div_desc" class="form-control" rows="4"></textarea>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal" style="float: left;">Close</button>
        <button id="button_divination_pick_submit" type="button" class="btn btn-success">Pick</button>
      </div>
    </div>
  </div>
</div>

<!-- SAVE CHARACTER Modal -->
<div class="modal fade" id="modal_save" tabindex="-1" role="dialog" aria-labelledby="modal_save_Label" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
        <h4 class="modal-title" id="modal_divination_Label">Save Character</h4>
      </div>
      <div class="modal-body">
        <label>Character Name: </label>&emsp;
        <input id="input_savemodal_char_name" disabled readonly class="form-control" style="display: inline; width: 200px;"/>
        <br/><br/>
        <label>Password: </label>&emsp;
        <input id="input_savemodal_pin" class="form-control" style="display: inline; width: 150px;"/>
        <br/><br/><br/>
        To retrieve your character you need to REMEMBER the character NAME and PASSWORD, or your character will lost in the database!
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal" style="float: left;">Close</button>
        <button id="button_savemodal_submit" type="button" disabled class="btn btn-success">Save</button> Almost ready!
      </div>
    </div>
  </div>
</div>

</body>

<script type="text/javascript">
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){ (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o), m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-55665952-1', 'auto');
  ga('send', 'pageview');
</script>

<script type="text/javascript">

var roleAptitudesElementsArray = new Array();
var globalAddedSkillCounter = 0;
var globalAddedStatCounter = 0;

//global status variables
var homeworldSelected = false;
var bgSelected = false;
var roleSelected = false;

$(function() {
  $("#nameError").toggle();
  
  for(var i = 0; i < backgroundArray.length; i++) {
    $("#select_background").append("<option value='"+ i + "'>" + backgroundArray[i] + "</option>");    
  };

  //setup subskillarray
  for(var i = 0; i < skillSubArray.length; i++) {
    skillSubArray[i] = new Array();
  }
  skillSubArray[6] = commonLoreArray;
  skillSubArray[9] = forbiddenLoreArray;
  skillSubArray[13] = linguisticsArray;
  skillSubArray[16] = navigateArray;
  skillSubArray[17] = operateArray;
  skillSubArray[20] = scholasticLoreArray;
  skillSubArray[27] = tradeArray;

  //setup trait table
  for(var i = 0; i < traitArray.length-21; i++) {
    //first part of row
    var s = "<tr><td id=\"tr_trait_" + i + "\" title=\"" + traitArray[i][1] + "\">" + traitArray[i][0] + "</td>";
    s += "<td><input id=\"checkbox_trait_" + i + "\" type=\"checkbox\" class=\"form-control\" style=\"width: 20px; height: 20px;\"/></td>";
    //second part of row
    var j = i+20;
    s += "<td id=\"tr_trait_" + j + "\" title=\"" + traitArray[j][1] + "\">" + traitArray[j][0] + "</td>";
    s += "<td><input id=\"checkbox_trait_" + j + "\" type=\"checkbox\" class=\"form-control\" style=\"width: 20px; height: 20px;\"/></td>";
    s += "</td></tr>";
    $("#tbody_traits").append(s);
  }
  //LAST ROW - ODD one out
  //first part of row
  var s = "<tr><td></td><td></td>";
  //second part of row
  var j = traitArray.length-1;
  s += "<td id=\"tr_trait_" + j + "\" title=\"" + traitArray[j][1] + "\">" + traitArray[j][0] + "</td>";
  s += "<td><input id=\"checkbox_trait_" + j + "\" type=\"checkbox\" class=\"form-control\" style=\"width: 20px; height: 20px;\"/></td>";
  s += "</td></tr>";
  $("#tbody_traits").append(s);

  //setup divination picker
  for(var i = 0; i < divinationArray.length; i++){
    var s = "<option value='" + i + "'>" + divinationArray[i][0];
    s += "</option>";
    $("#select_divination").append(s);
  }
});

$("#select_divination").change(function() {
  var index = parseInt($("#select_divination option:selected").val());
  $("#textarea_div_desc").html(divinationArray[index][1]);
});

$("#select_skills").change(function() {
  $("#button_addskill").attr("disabled", false);
});

$("#select_stats").change(function() {
  $("#button_addstat").attr("disabled", false);
});

$("#button_addskill").on("click", function() {
  var index = parseInt($("#select_skills option:selected").val());
  var hasSubSection = false;
  var subSectionIndex = 0;  
  //$("#select_skills option:selected").prop("selected", false);
  if($("#select_skills option:selected").val().split("_").length > 1){
   hasSubSection = true;
   subSectionIndex = parseInt($("#select_skills option:selected").val().split("_")[1]);
  }
  if($("#select_skills").val() != "Select a Skill"){
    $("#select_skills").val("Select a Skill");    
    $("#button_addskill").attr("disabled", true);
    if(hasSubSection){
      $("#select_skills option[value='"+ index + "_" + subSectionIndex + "']").attr("disabled", true);
    }
    else $("#select_skills option[value='"+ index + "']").attr("disabled", true);
  }
  var apt1 = skillArray[index][1];
  var apt2 = skillArray[index][2];
  var numAptMatches = 0;
  //find homeworld aptitude
  var homeworldApt = $("#aptitude_i_world").html();
  var hwAptIndex = 0;
  for(var i = 0; i < aptitudeArray.length; i++) {
    if(aptitudeArray[i] == homeworldApt) hwAptIndex = i;
  }
  homeworldApt = hwAptIndex;
  if((aptitudeArray[homeworldApt] == aptitudeArray[apt1] || aptitudeArray[homeworldApt] == aptitudeArray[apt2]) ||  apt1 == 0) numAptMatches++;
  //find background aptitude
  var bgAptitude = $("#select_bgAptitude").val();
  if((aptitudeArray[bgAptitude] == aptitudeArray[apt1] || aptitudeArray[bgAptitude] == aptitudeArray[apt2]) ||  apt2 == 0) numAptMatches++;
  //find role aptitudes
  var roleAptitudes = new Array();
  for(var i = 0; i < roleAptitudesElementsArray.length; i++) {
    var elementName = roleAptitudesElementsArray[i];
    var elementValue = $(elementName).html();
    if(elementName.indexOf("select") >= 0) elementValue = $(elementName + " option:selected").val();
    if(elementValue == aptitudeArray[apt1] || elementValue == aptitudeArray[apt2]) numAptMatches++;
  }
  var s = "<tr id=\"tr_skillrow_" + globalAddedSkillCounter + "\">";
  if(hasSubSection) {
    s += "<td id=\"tr_skillrow_" + globalAddedSkillCounter + "_td_name\">" + skillArray[index][0] + " - ";
    switch(index) {
      case 6:
        s += commonLoreArray[subSectionIndex];
        break;
      case 9:
        s += forbiddenLoreArray[subSectionIndex];
        break;
      case 13:
        s += linguisticsArray[subSectionIndex];
        break;
      case 16:
        s += navigateArray[subSectionIndex];
        break;
      case 17:
        s += operateArray[subSectionIndex];
        break;
      case 20:
        s += scholasticLoreArray[subSectionIndex];
        break;
      case 25:
        s += tradeArray[subSectionIndex];
        break;
    }
    s += "</td>";
  }
  else s += "<td id=\"tr_skillrow_" + globalAddedSkillCounter + "_td_name\">" + skillArray[index][0] + "</td>";
  //calc xp cost for level display
  var xp_Known = calcSkillCost(numAptMatches, "known", false);
  var xp_Trained = calcSkillCost(numAptMatches, "trained", false);
  var xp_Experienced = calcSkillCost(numAptMatches, "experienced", false);
  var xp_Expert = calcSkillCost(numAptMatches, "expert", false);
  //console.log("costs: " + xp_Known + " - " + xp_Trained + " - " + xp_Experienced + " - " + xp_Expert);

  s += "<td id=\"matches_" + globalAddedSkillCounter + "\">" + numAptMatches + "</td>";
  s += "<td><input id=\"checkbox_" + globalAddedSkillCounter + "_1\" data-skillnum=\"" + globalAddedSkillCounter + "\" type=\"checkbox\" class=\"form-control known\" style=\"display: inline; width: 20px; height: 20px;\" />&emsp;(" + xp_Known +"xp)</td>";
  s += "<td><input id=\"checkbox_" + globalAddedSkillCounter + "_2\" data-skillnum=\"" + globalAddedSkillCounter + "\" type=\"checkbox\" class=\"form-control trained\" style=\"display: inline; width: 20px; height: 20px;\" disabled/>&emsp;(" + xp_Trained +"xp)</td>";
  s += "<td><input id=\"checkbox_" + globalAddedSkillCounter + "_3\" data-skillnum=\"" + globalAddedSkillCounter + "\" type=\"checkbox\" class=\"form-control experienced\" style=\"display: inline; width: 20px; height: 20px;\" disabled/>&emsp;(" + xp_Experienced +"xp)</td>";
  s += "<td><input id=\"checkbox_" + globalAddedSkillCounter + "_4\" data-skillnum=\"" + globalAddedSkillCounter + "\" type=\"checkbox\" class=\"form-control expert\" style=\"display: inline; width: 20px; height: 20px;\" disabled/>&emsp;(" + xp_Expert +"xp)</td>";
  s += "<td><button id=\"button_removeskill_" + globalAddedSkillCounter + "\" class=\"btn btn-xs btn-danger\" data-rowid=\"" + globalAddedSkillCounter + "\" data-xpcost=\"0\" data-optionvalue=\"" + index + "\" data-optionsubvalue=\"" + subSectionIndex + "\">Remove</button</td>";
  s += "</tr>";
  $("#tbody_skills").append(s);
  //append 'known' box script
  var s2 = '<script>$("#checkbox_' + globalAddedSkillCounter + '_1").on("click", function() { var rowId = $(this).data("skillnum"); var numMatches = parseInt($("#matches_" + rowId).html()); var xpCost = 0; if($(this).is(":checked")) { xpCost = calcSkillCost(numMatches, "known", false); if(!BuySkill(xpCost, rowId, false)) { $(this).attr("checked", false); HighLightXPBox(); } else { $("#checkbox_' + globalAddedSkillCounter + '_2").attr("disabled", false); HideXPErrorBox(); }} else { xpCost = calcSkillCost(numMatches, "known", true); BuySkill(xpCost, rowId, true); $("#checkbox_' + globalAddedSkillCounter + '_2").attr("disabled", true); HideXPErrorBox(); } });</scrip';
  s2 += 't>';
  $("body").append(s2);
  //append 'trained' box script
  var s3 = '<script>$("#checkbox_' + globalAddedSkillCounter + '_2").on("click", function() { var rowId = $(this).data("skillnum"); var numMatches = parseInt($("#matches_" + rowId).html()); var xpCost = 0; if($(this).is(":checked")) { xpCost = calcSkillCost(numMatches, "trained", false); if(!BuySkill(xpCost, rowId, false)) { $(this).attr("checked", false); HighLightXPBox(); } else { $("#checkbox_' + globalAddedSkillCounter + '_3").attr("disabled", false); HideXPErrorBox(); }} else { xpCost = calcSkillCost(numMatches, "trained", true); BuySkill(xpCost, rowId, true); $("#checkbox_' + globalAddedSkillCounter + '_3").attr("disabled", true); HideXPErrorBox(); }  });</scrip';
  s3 += 't>';
  $("body").append(s3);
  //append 'experienced' box script
  var s4 = '<script>$("#checkbox_' + globalAddedSkillCounter + '_3").on("click", function() { var rowId = $(this).data("skillnum"); var numMatches = parseInt($("#matches_" + rowId).html()); var xpCost = 0; if($(this).is(":checked")) { xpCost = calcSkillCost(numMatches, "experienced", false); if(!BuySkill(xpCost, rowId, false)) { $(this).attr("checked", false); HighLightXPBox(); } else { $("#checkbox_' + globalAddedSkillCounter + '_4").attr("disabled", false); HideXPErrorBox(); }} else { xpCost = calcSkillCost(numMatches, "experienced", true); BuySkill(xpCost, rowId, true); $("#checkbox_' + globalAddedSkillCounter + '_4").attr("disabled", true); HideXPErrorBox(); }  });</scrip';
  s4 += 't>';
  $("body").append(s4);
  //append 'veteran' box script
  var s5 = '<script>$("#checkbox_' + globalAddedSkillCounter + '_4").on("click", function() { var rowId = $(this).data("skillnum"); var numMatches = parseInt($("#matches_" + rowId).html()); var xpCost = 0; if($(this).is(":checked")) { xpCost = calcSkillCost(numMatches, "expert", false); if(!BuySkill(xpCost, rowId, false)) { $(this).attr("checked", false); HighLightXPBox(); }} else { xpCost = calcSkillCost(numMatches, "expert", true); BuySkill(xpCost, rowId, true); HideXPErrorBox(); }  });</scrip';
  s5 += 't>';
  $("body").append(s5);
  //append remove button script to body
  var removeButtonScript = '<script>$("#button_removeskill_' + globalAddedSkillCounter + '").on("click", function () { var rowId = parseInt($(this).data("rowid")); var cost = parseInt($(this).data("xpcost")); RemoveSkillRow(cost, rowId);  HideXPErrorBox(); RestoreSkill($(this).data("optionvalue"), $(this).data("optionsubvalue"));});</scrip';
  removeButtonScript += 't>';
  $("body").append(removeButtonScript);
  //
  globalAddedSkillCounter++;
});

$("#button_addstat").on("click", function() {
  var index = parseInt($("#select_stats option:selected").val());
  //prevent adding same stat twice
  if($("#select_stats").val() != "Select a Stat"){
    $("#select_stats").val("Select a Stat");    
    $("#button_addstat").attr("disabled", true);
    $("#select_stats option[value='"+ index + "']").attr("disabled", true);
  }
  var apt1 = statLongArray[index][1];
  var apt2 = statLongArray[index][2];
  var numAptMatches = 0;
  //find homeworld aptitude
  var homeworldApt = $("#aptitude_i_world").html();
  var hwAptIndex = 0;
  for(var i = 0; i < aptitudeArray.length; i++) {
    if(aptitudeArray[i] == homeworldApt) hwAptIndex = i;
  }
  homeworldApt = hwAptIndex;
  if((aptitudeArray[homeworldApt] == aptitudeArray[apt1] || aptitudeArray[homeworldApt] == aptitudeArray[apt2]) ||  apt1 == 0) numAptMatches++;
  //find background aptitude
  var bgAptitude = $("#select_bgAptitude").val();
  if((aptitudeArray[bgAptitude] == aptitudeArray[apt1] || aptitudeArray[bgAptitude] == aptitudeArray[apt2]) ||  apt2 == 0) numAptMatches++;
  //find role aptitudes
  var roleAptitudes = new Array();
  for(var i = 0; i < roleAptitudesElementsArray.length; i++) {
    var elementName = roleAptitudesElementsArray[i];
    var elementValue = $(elementName).html();
    if(elementName.indexOf("select") >= 0) elementValue = $(elementName + " option:selected").val();
    if(elementValue == aptitudeArray[apt1] || elementValue == aptitudeArray[apt2]) numAptMatches++;
  }
  var s = "<tr id=\"tr_statrow_" + globalAddedStatCounter + "\">";
  s += "<td id='tr_statrow_" + globalAddedStatCounter + "_td_name'>" + statLongArray[index][0] + "</td>";
  //calc xp cost for level display
  var xp_Simple = calcStatCost(numAptMatches, "simple", false);
  var xp_Intermediate = calcStatCost(numAptMatches, "intermediate", false);
  var xp_Trained = calcStatCost(numAptMatches, "trained", false);
  var xp_Proficient = calcStatCost(numAptMatches, "proficient", false);
  var xp_Expert = calcStatCost(numAptMatches, "expert", false);

  s += "<td id=\"matches_stat_" + globalAddedStatCounter + "\">" + numAptMatches + "</td>";
  s += "<td><input id=\"checkbox_stat_" + globalAddedStatCounter + "_1\" data-statnum=\"" + globalAddedStatCounter + "\" type=\"checkbox\" class=\"form-control\" style=\"display: inline; width: 20px; height: 20px;\" />&emsp;(" + xp_Simple +"xp)</td>";
  s += "<td><input id=\"checkbox_stat_" + globalAddedStatCounter + "_2\" data-statnum=\"" + globalAddedStatCounter + "\" type=\"checkbox\" class=\"form-control\" style=\"display: inline; width: 20px; height: 20px;\" disabled/>&emsp;(" + xp_Intermediate + "xp)</td>";
  s += "<td><input id=\"checkbox_stat_" + globalAddedStatCounter + "_3\" data-statnum=\"" + globalAddedStatCounter + "\" type=\"checkbox\" class=\"form-control\" style=\"display: inline; width: 20px; height: 20px;\" disabled/>&emsp;(" + xp_Trained + "xp)</td>";
  s += "<td><input id=\"checkbox_stat_" + globalAddedStatCounter + "_4\" data-statnum=\"" + globalAddedStatCounter + "\" type=\"checkbox\" class=\"form-control\" style=\"display: inline; width: 20px; height: 20px;\" disabled/>&emsp;(" + xp_Proficient + "xp)</td>";
  s += "<td><input id=\"checkbox_stat_" + globalAddedStatCounter + "_5\" data-statnum=\"" + globalAddedStatCounter + "\" type=\"checkbox\" class=\"form-control\" style=\"display: inline; width: 20px; height: 20px;\" disabled/>&emsp;(" + xp_Expert + "xp)</td>";
  s += "<td><button id=\"button_removestat_" + globalAddedStatCounter + "\" class=\"btn btn-xs btn-danger\" data-rowid=\"" + globalAddedStatCounter + "\" data-xpcost=\"0\" data-optionvalue=\"" + index + "\">Remove</button</td>";
  s += "</tr>";
  $("#tbody_stats").append(s);
  //append 'simple' box script
  var s2 = '<script>$("#checkbox_stat_' + globalAddedStatCounter + '_1").on("click", function() { var rowId = $(this).data("statnum"); var numMatches = parseInt($("#matches_stat_" + rowId).html()); var xpCost = 0; if($(this).is(":checked")) { xpCost = calcStatCost(numMatches, "simple", false); if(!BuyStat(xpCost, rowId, false)) { $(this).attr("checked", false); HighLightStatXPBox(); } else { $("#checkbox_stat_' + globalAddedStatCounter + '_2").attr("disabled", false); HideStatXPErrorBox(); }} else { xpCost = calcStatCost(numMatches, "simple", true); BuyStat(xpCost, rowId, true); $("#checkbox_stat_' + globalAddedStatCounter + '_2").attr("disabled", true); HideStatXPErrorBox(); } });</scrip';
  s2 += 't>';
  $("body").append(s2);
  //append 'intermediate' box script
  var s3 = '<script>$("#checkbox_stat_' + globalAddedStatCounter + '_2").on("click", function() { var rowId = $(this).data("statnum"); var numMatches = parseInt($("#matches_stat_" + rowId).html()); var xpCost = 0; if($(this).is(":checked")) { xpCost = calcStatCost(numMatches, "intermediate", false); if(!BuyStat(xpCost, rowId, false)) { $(this).attr("checked", false); HighLightStatXPBox(); } else { $("#checkbox_stat_' + globalAddedStatCounter + '_3").attr("disabled", false); HideStatXPErrorBox(); }} else { xpCost = calcStatCost(numMatches, "intermediate", true); BuyStat(xpCost, rowId, true); $("#checkbox_stat_' + globalAddedStatCounter + '_3").attr("disabled", true); HideStatXPErrorBox(); } });</scrip';
  s3 += 't>';
  $("body").append(s3);
  //append 'trained' box script
  var s4 = '<script>$("#checkbox_stat_' + globalAddedStatCounter + '_3").on("click", function() { var rowId = $(this).data("statnum"); var numMatches = parseInt($("#matches_stat_" + rowId).html()); var xpCost = 0; if($(this).is(":checked")) { xpCost = calcStatCost(numMatches, "trained", false); if(!BuyStat(xpCost, rowId, false)) { $(this).attr("checked", false); HighLightStatXPBox(); } else { $("#checkbox_stat_' + globalAddedStatCounter + '_4").attr("disabled", false); HideStatXPErrorBox(); }} else { xpCost = calcStatCost(numMatches, "trained", true); BuyStat(xpCost, rowId, true); $("#checkbox_stat_' + globalAddedStatCounter + '_4").attr("disabled", true); HideStatXPErrorBox(); }  });</scrip';
  s4 += 't>';
  $("body").append(s4);
  //append 'proficient' box script
  var s5 = '<script>$("#checkbox_stat_' + globalAddedStatCounter + '_4").on("click", function() { var rowId = $(this).data("statnum"); var numMatches = parseInt($("#matches_stat_" + rowId).html()); var xpCost = 0; if($(this).is(":checked")) { xpCost = calcStatCost(numMatches, "experienced", false); if(!BuyStat(xpCost, rowId, false)) { $(this).attr("checked", false); HighLightStatXPBox(); } else { $("#checkbox_stat_' + globalAddedStatCounter + '_5").attr("disabled", false); HideStatXPErrorBox(); }} else { xpCost = calcStatCost(numMatches, "experienced", true); BuyStat(xpCost, rowId, true); $("#checkbox_stat_' + globalAddedStatCounter + '_5").attr("disabled", true); HideStatXPErrorBox(); }  });</scrip';
  s5 += 't>';
  $("body").append(s5);
  //append 'expert' box script
  var s6 = '<script>$("#checkbox_stat_' + globalAddedStatCounter + '_5").on("click", function() { var rowId = $(this).data("statnum"); var numMatches = parseInt($("#matches_stat_" + rowId).html()); var xpCost = 0; if($(this).is(":checked")) { xpCost = calcStatCost(numMatches, "expert", false); if(!BuyStat(xpCost, rowId, false)) { $(this).attr("checked", false); HighLightStatXPBox(); }} else { xpCost = calcStatCost(numMatches, "expert", true); BuyStat(xpCost, rowId, true); HideStatXPErrorBox(); }  });</scrip';
  s6 += 't>';
  $("body").append(s6);
  //append remove button script to body
  var removeButtonScript = '<script>$("#button_removestat_' + globalAddedStatCounter + '").on("click", function () { var rowId = parseInt($(this).data("rowid")); var cost = parseInt($(this).data("xpcost")); RemoveStatRow(cost, rowId);  HideStatXPErrorBox(); RestoreStat($(this).data("optionvalue"));});</scrip';
  removeButtonScript += 't>';
  $("body").append(removeButtonScript);
  //
  globalAddedStatCounter++;
});

function RemoveSkillRow(cost, rowId){
  adjustExp(-cost);
  $("#tr_skillrow_" + rowId).remove();
}

function RemoveStatRow(cost, rowId){
  adjustExp(-cost);
  $("#tr_statrow_" + rowId).remove();
}

function BuySkill(cost, rowId, refund){
  if(CanBuy(cost)){
    var existingRefundCost = parseInt($("#button_removeskill_" + rowId).attr("data-xpcost"));
    if(!refund) $("#button_removeskill_" + rowId).attr("data-xpcost", (existingRefundCost + cost)); //setup remove button (box ticked)
    else $("#button_removeskill_" + rowId).attr("data-xpcost", (existingRefundCost + cost)); //setup remove button (boxes unticked)
    adjustExp(cost);
    return true;
  }
  else return false;
}

function BuyStat(cost, rowId, refund){
  if(CanBuy(cost)){
    var existingRefundCost = parseInt($("#button_removestat_" + rowId).attr("data-xpcost"));
    if(!refund) $("#button_removestat_" + rowId).attr("data-xpcost", (existingRefundCost + cost)); //setup remove button (box ticked)
    else $("#button_removestat_" + rowId).attr("data-xpcost", (existingRefundCost + cost)); //setup remove button (boxes unticked)
    adjustExp(cost);
    return true;
  }
  else return false;
}

function CanBuy(cost){
  var remainingXp = parseInt($("#input_exp").val());
  return ((remainingXp-cost) >= 0)? true:false;
}

function calcSkillCost(numMatches, level, neg){
  var xpCost = 0;
  if(numMatches > 2) numMatches = 2;
  switch(level){
    case "known":
      xpCost = skillAptExpArray[numMatches];
      break;

    case "trained":
      xpCost = skillAptExpArray[numMatches]*2;
      break;

    case "experienced":
      xpCost = skillAptExpArray[numMatches]*3;
      break;

    case "expert":
      xpCost = skillAptExpArray[numMatches]*4;
      break;
  }  
  if(neg) xpCost = -xpCost;  
  return xpCost;
}

function calcStatCost(numMatches, level, neg){
  var xpCost = 0;
  if(numMatches > 2) numMatches = 2;
  switch(level){
    case "simple":
      xpCost = statAptExpArray[numMatches][0];
      break;

    case "intermediate":
      xpCost = statAptExpArray[numMatches][1];
      break;

    case "trained":
      xpCost = statAptExpArray[numMatches][2];
      break;

    case "proficient":
      xpCost = statAptExpArray[numMatches][3];
      break;

    case "expert":
      xpCost = statAptExpArray[numMatches][4];
      break;
  }  
  if(neg) xpCost = -xpCost;  
  return xpCost;
}

function adjustExp(value){
  var currentExp = parseInt($("#input_exp").val());
  var newExp = currentExp - value;
  $("#input_exp").val(newExp);
}

function fillSkillPicker(){
  //fill skill picker select
  for(var i = 0; i < skillArray.length; i++){
    if(i != 6 && i != 9 && i != 13 && i != 16 && i != 17 && i != 20 && i != 27) {
      $("#select_skills").append("<option value=\"" + i + "\" >" + skillArray[i][0] + " (" + aptitudeArray[skillArray[i][1]] + ", " + aptitudeArray[skillArray[i][2]] + ")</option>");
    }
    else {
      var s = "<optgroup label='" + skillArray[i][0] + " (" + aptitudeArray[skillArray[i][1]] + ", " + aptitudeArray[skillArray[i][2]] + ")'>";
      for(var j = 1; j < skillSubArray[i].length; j++) {
        s += "<option value='" + i + "_" + j + "'>" + skillSubArray[i][j] + "</option>";
      }
      s += "</opgroup>";
      $("#select_skills").append(s);
    }
  }
}

function fillStatPicker(){
  //fill stat picker select
  for(var i = 0; i < statLongArray.length; i++) {
    $("#select_stats").append("<option value=\"" + i + "\" >" + statLongArray[i][0] + " (" + aptitudeArray[statLongArray[i][1]] + ", " + aptitudeArray[statLongArray[i][2]] + ")</option>");
  }
}

function fillTalentPicker_1(){
  //fill tier 1 talent picker select
  for(var i = 0; i < talents_tier1_Array.length; i++){
    if(i != 6 && i != 9 && i != 13 && i != 16 && i != 17 && i != 20 && i != 27) {
      $("#select_talent_1").append("<option value=\"" + i + "\" >" + talents_tier1_Array[i][0] + "</option>");
    }
    else {
      var s = "<optgroup label='" + talents_tier1_Array[i][0] + "'>";
      for(var j = 0; j < talents_tier1_SubArray[i].length; j++) {
        s += "<option value='" + i + "_" + j + "'>" + talents_tier1_SubArray[i][j] + "</option>";
      }
      s += "</opgroup>";
      $("#select_talent_1").append(s);
    }
  }
}

var statsArray = ["ws", "bs", "s", "t", "ag", "int", "per", "wp", "fel", "infl"];

var skillAptExpArray = [300, 200, 100];
var statAptExpArray = [
[500, 750, 1000, 1500, 2500],
[250, 500, 750, 1000, 1500],
[100, 250, 500, 750, 1250]];

var backgroundArray = [
'Adeptus Administratum', 'Adeptus Arbites', 'Adeptus Astra Telepathica', 
'Adeptus Mechanicus', 'Adeptus Ministorum', 'Imperial Guard', 'Outcast' ];

var backgroundSkillsArray = [
['Commerce OR Medicae', 'Common Lore (Adeptus Administratum)', 'Linguistics (High Gothic)', 'Logic', 'Scholastic Lore (-Pick One-)'],
['Awareness', 'Common Lore (Adeptus Arbites)', 'Common Lore (Underworld)', 'Inquiry OR Interrogation', 'Intimidate', 'Scrutiny'],
['Awareness', 'Common Lore (Adeptus Astra Telepathica)', 'Deceive OR Interrogation', 'Forbidden Lore (The Warp)', 'Psyniscience OR Scrutiny'],
['Awareness OR Operate(-Pick One-)', 'Common Lore (Adeptus Mechanicus)', 'Logic', 'Security', 'Tech Use'],
['Charm', 'Command', 'Common Lore (Adeptus Ministorum)', 'Inquiry OR Scrutiny', 'Linguistics(High Gothic)'],
['Athletics', 'Command', 'Common Lore (Imperial Guard)', 'Medicae OR Operate (Surface)', 'Navigate (surface)'],
['Acrobatics', 'Common Lore (Underworld)', 'Deceive', 'Dodge', 'Stealth']];

var backgroundTalentsArray = [
['Weapon Training (Las or SP)'],
['Weapon Training (Shock or SP)'],
['Weapon Training (Las)', 'Weapon Training (Low Tech)'],
['Mechadendrite Use (Utility)', 'Weapon Training (SP)'],
['Weapon Training (Low Tech and SP) OR (Flame)'],
['Weapon Training (Las, Low Tech)'],
['Weapon Training (Chain and (Las OR SP))']];

var beackgroundEquipmentArray = [
['Laspistol OR Stub Automatic', 'Imperial Robes', 'Autoquill', 'Chrono', 'Dataslate', 'Medi-kit'],
['Shotgun or Shock Maul', 'Enforcer Light Carapace Armour OR Carapace Chestplate', '3 Doses of Stimm', 'Manacles', '12 Lho Sticks'],
['Laspistol', 'Staff or Whip', 'Light Flakcloak or Flak Vest', 'Micro-Bead or Psy Focus'],
['Autogun or Hand Cannon', 'Monotask Servo-Skull (Utility) or Optical Mechadendrite', 'Imperial Robes', '2 Vials of Sacred Unguents'],
['Hand flamer (or Warhammer and Stub Revolver)', 'Imperial Robes or Rlak Vest', 'Backpack', 'Glow-Globe', 'Monotask Servo-Skull (Laud Hailer)'],
['Lasgun (or Laspistol and Sword)', 'Combat Vest', 'Imperial Guard Flak Armour', 'Grapnel and Line', '12 Lho Sticks', 'Magnoculars'],
['Autopistol or Laspistol', 'Chainsword', 'Armoured Bodyglove or Flak Vest', 'Injector', '2 Doses of Obscura or Slaught'],
];

var roleAptitudeArray = [
['Agility', ['Ballistic Skill', 'Weapon Skill'], 'Fieldcraft', 'Finesse', 'Perception'],
['Fieldcraft', 'Intelligence', 'Knowledge', 'Strength', 'Toughness'],
['Agility', 'Ballistic Skill', 'Defence', 'Fellowship', 'Finesse'],
['Fellowship', 'Offence', 'Social', 'Toughness', 'Willpower'],
['Defence', 'Intelligence', 'Knowledge', 'Perception', 'Willpower'],
['Intelligence', 'Knowledge', 'Perception', 'Tech', 'Willpower'],
['Fellowship', 'Intelligence', 'Perception', 'Social', 'Tech'],
['Ballistic Skill', 'Defence', 'Offence', 'Strength', 'Weapon Skill']];

var roleTalentArray = [
'Jaded OR Leap Up',
'Resistance (-Pick One-) OR Takedown',
'Catfall OR Quick Draw',
'Double Team OR Hatred (-Pick One-)',
'Resistance (Psychic Powers) OR Warp Sense',
'Ambidextrous OR Clues from the Crowds',
'Keen Intuition OR Disarm',
'Iron Jaw OR Rapid Reload'];

var aptitudeArray = [
'General',          //0
'Weapon Skill',
'Ballistic Skill',  //2
'Strength',
'Toughness',        //4
'Agility',
'Intelligence',     //6
'Perception',
'Willpower',        //8
'Fellowship',

'Offence',          //10
'Defence',
'Finesse',          //12
'Knowledge',
'Fieldcraft',       //14
'Psyker',
'Social',           //16
'Tech',
'Leadership',       //18
];

var statLongArray = [
['Weapon Skill', 1, 10],
['Ballistic Skill', 2, 12], //1
['Strength', 3, 10],
['Toughness', 4, 11],       //3
['Agility', 5, 12],
['Intelligence', 6, 13],    //5
['Perception', 7, 14],
['Willpower', 8, 15],       //7
['Fellowship', 9, 16]];

var skillArray = [
['Acrobatics', 5, 0],
['Athletics', 3, 0],
['Awareness', 7, 14],
['Charm', 9, 16],
['Command', 9, 18],
['Commerce', 6, 13], //5
['Common Lore', 6, 0], //6
['Deceive', 9, 16],
['Dodge', 5, 11],
['Forbidden Lore', 6, 13], //9
['Inquiry', 9, 16], //10
['Interrogation', 8, 16],
['Intimidate', 3, 16],
['Linguistics', 6, 0], //13
['Logic', 6, 13],
['Medicae', 6, 14],
['Navigate', 6, 14], //16
['Operate', 5, 14], //17
['Parry', 1, 11],
['Psyniscience', 7, 15],
['Scholastic Lore', 6, 13], //20
['Scrutiny', 7, 0],
['Security', 6, 17],
['Sleight of Hand', 5, 13],
['Stealth', 5, 14],
['Survival', 7, 14], //25
['Tech-Use', 6, 17],
['Trade', 6, 0]]; //27

var skillSubArray = new Array(skillArray.length);

var commonLoreArray = [
'',
'Adeptus Arbites',
'Adeptus Astartes',
'Adeptus Astra Telepathica',
'Adeptus Mechanicus',
'Adetpus Sororitas',
'Askellon Sector',
'Chartist Captains',
'Collegia Titanicus',
'Ecclesiarchy',
'Imperial Creed',
'Imperial Guard',
'Imperial Navy',
'Imperium',
'Navigators',
'Planetary Defence Forces',
'Rogue Traders',
'Schola Progenium',
'Tech',
'Underworld',
'War',
'OTHER',
];

var linguisticsArray = [
'',
'Chapter Runes',
'Chaos Marks',
'Eldar',
'High Gothic',
'Imperial Codes',
'Low Gothic',
'Mercenary Cant',
'Necrontyr',
'Ork',
'Techna-Lingua',
'Tau',
'Underworld',
'Xenos Markings',
'OTHER',
];

var navigateArray = [
'',
'Surface',
'Stellar',
'Warp',
];

var operateArray = [
'',
'Aeronautica',
'Surface',
'Voidship',
];

var scholasticLoreArray = [
'',
'Astromancy',
'Beasts',
'Bureaucracy',
'Chymistry',
'Cryptology',
'Heraldry',
'Imperial Warrants',
'Legend',
'Numerology',
'Occult',
'Philosophy',
'Tactica Imperialis',
'OTHER'];

var tradeArray = [
'',
'Agri',
'Archaeologist',
'Armourer',
'Astographer',
'Chymist',
'Cryptographer',
'Cook',
'Explorator',
'Linguist',
'Loremancer',
'Morticator',
'Performancer',
'Prospector',
'Scrimshawer',
'Sculptor',
'Shipwright',
'Soothsayer',
'Technomat',
'Voidfarer'];

var traitArray = [
  ['Amorphous', 'Creature is a formless blob, and slow.'], //0
  ['Amphibious', 'Creature can breathe underwater.'],
  ['Auto-Stabilised', 'Always counts as BRACED.'],
  ['Baneful Prescence', 'Creature inflicts Willpower penalty to nearby characters.'],
  ['Bestial', 'Automatically passes Survival skill tests, test Willpower to avoid flight.'], //4
  ['Blind', 'Cannot see.'],
  ['Brutal Charge', 'Deals additional damage on a Charge'],
  ['Burrower', 'Move by digging.'],
  ['Crawler', 'No penalties for moving over difficult terrain.'],
  ['Daemonic', 'Bonus TB againt normal weapons, immune to disease and poision.'], //9
  ['Dark Sight', 'Can see in darkness'], //10
  ['Deadly Natural Weapons', 'Natural weapons are no longer primitive.'],
  ['Fear', 'Forces others to make Fear tests to avoid Shock & Madness.'],
  ['Flyer', 'Fly and enter any altitude.'],
  ['From Beyond', 'Immune to Fear, Pinning, Insanity Points and mind-affecting powers.'], //14
  ['Hoverer', 'Fly and enter the Hover altitude.'],
  ['Incorporeal', 'Insubstantial and weightless, cannot be affected by mundane weaponry'],
  ['Machine', 'Creature gains immunities and resistances.'],
  ['Mechanicus Implants', 'Character has mechanical augmentation.'],
  ['Mind Lock', 'If not properly controlled, character can become Stunned.'], //19

  ['Multiple Arms', 'Creature gains extra attacks.'], //20
  ['Natural Armour', 'Gain additional Armour points to all locations.'],
  ['Natural Weapons', 'Unarmed attacks deal 1d10+SB damage.'],
  ['Phase', 'Switch between incorporeal and corporeal as a Half Action.'],
  ['Psyker', 'Creature has a psy rating of 1 or more.'],
  ['Quadruped', 'Movement equals ABx2'],
  ['Regeneration', 'Test Toughness to remove 1 or more damage.'],
  ['Sanctioned', 'Avoid Corruption from Psyker elite advance; start at psy rating 2.'],
  ['Size', 'Determines creature size and benefits.'],
  ['Sonar Sense', 'Perceive surroundings flawlessly within 30 metres.'],
  ['Soul Bound', 'Bound to a particular group or creatures in exchange for certain benefits.'],
  ['Stampede', 'Failed Willpower test causes creature to flee, trampling anything in its path.'],
  ['Stuff of Nightmares', 'Become immune to most conditions that would harm normal creatures.'],
  ['Sturdy', '+20 bonus to resist grapple, Knock Down and Takedown.'],
  ['Touched by the Fates', 'NPC has Fate points.'],
  ['Toxic', 'Gain poisonous attack.'],
  ['Undying', 'The creature is immune to many environmental and natural dangers.'],
  ['Unnatural Characteristic', 'Increases one characteristic bonus.'],
  ['Unnatural Senses', 'Perceive surroundings by uncanny means.'],
  ['Warp Instability', 'Creature must deal damage if damaged, or be cast back into the Warp.'],

  ['Warp Weapons', 'Creature&#39;s attacks ignore armour.'], //40
];

var forbiddenLoreArray = arrayUnique(commonLoreArray.concat(scholasticLoreArray));

var talents_tier1_Array = [
['Ambidextrous', [5], [30], [], [1, 2], 'Reduce penalties for using two weapons.'] //name, stat prereq, stat prereq value, text prereq, aptitudes
];

var talents_tier1_SubArray = [
]

function arrayUnique(array) {
    var a = array.concat();
    for(var i=0; i<a.length; ++i) {
        for(var j=i+1; j<a.length; ++j) {
            if(a[i] === a[j])
                a.splice(j--, 1);
        }
    }
    return a;
};

$("#button_namegenerate").on("click", function(){
  
  if($("#nameError").is(":visible")) {
    $("#nameError").toggle();
  }
	var index = 0;
	
	var male = $("#radio_gender_male").is(":checked");
	var female = $("#radio_gender_female").is(":checked");
	if(male) {
    index = RandomNumberPlz(0, maleNameArray.length);
    $("#box_name").val(maleNameArray[index]);
	}
	else if(female){
    index = RandomNumberPlz(0, femaleNameArray.length);
    $("#box_name").val(femaleNameArray[index]);
	}
	else $("#nameError").toggle();
});

$("#select_roles")
  .change(function() {
    $( "#select_roles option:selected" ).each(function() {
      if(parseInt($("#select_bgAptitude option:selected").val()) > 0) {
        if($("#tr_role_aptitude_1_clash").is(":visible")) $("#tr_role_aptitude_1_clash").toggle();      
        $("#tbody_rolebonus").empty();
        $("#tbody_roletalents").empty();      
        var roleIndex = parseInt($(this).val());
        $("#tbody_roleaptitudes").empty();
        var roleIndex = parseInt($(this).val());
        var elementCounter = 0;
        roleAptitudesElementsArray = new Array();
        for(var i = 0; i < roleAptitudeArray[roleIndex].length; i++) {
        	var s = "<tr><td></td><td><i id='role_apt_" + elementCounter + "'>" + roleAptitudeArray[roleIndex][i] + "</i></td>";          
          
          if((roleAptitudeArray[roleIndex][i]) == $("#aptitude_i_world").html() || roleAptitudeArray[roleIndex][i] == aptitudeArray[parseInt($("#select_bgAptitude").val())]) {
            s = s.substring(0, s.length-(28+roleAptitudeArray[roleIndex][i].length));
            s += '<select id="select_role_apt_' + elementCounter + '" class=\"form-control\" style=\"color: red; border: 1px solid red; display: inline; width: 200px;\"><option disabled selected>CLASH! Pick a Stat</option>';
            for(var j = 1; j < 10; j++){
              if(aptitudeArray[j] != roleAptitudeArray[roleIndex][i]) {
                s += '<option value="' + aptitudeArray[j] + '" style=\"color: #555;\">' + aptitudeArray[j] + '</option>';
              }
            }
            s += '</select></td>';
            roleAptitudesElementsArray.push("#select_role_apt_" + elementCounter);
        	}
          else if(roleAptitudeArray[roleIndex][i][0].length > 1){
            var fudge = ("<i  id='role_apt_0'>" + "</i></td>").length;
            for(var k = 0; k < roleAptitudeArray[roleIndex][i].length; k++){
              fudge += roleAptitudeArray[roleIndex][i][k].length;
            }
            s = s.substring(0, s.length-(fudge));
            s += '<select id="select_role_apt_' + elementCounter + '" class=\"form-control\" style=\"color: red; border: 1px solid red; display: inline; width: 200px;\"><option disabled selected>CHOICE! Pick a Stat</option>';
            for(var j = 0; j < roleAptitudeArray[roleIndex][i].length; j++){
              s += '<option value="' + aptitudeArray[j+1] + '" style=\"color: #555;\">' + aptitudeArray[j+1] + '</option>';
            }
            s += '</select></td>';
            roleAptitudesElementsArray.push("#select_role_apt_" + elementCounter);
          }
          else roleAptitudesElementsArray.push("#role_apt_" + elementCounter);
        	s += "</tr>";       
          $("#tbody_roleaptitudes").append(s);
          var elementName = 'select_role_apt_' + elementCounter;
          var roleAptSelectScript = "<script type=\"text/javascript\">$(\"#" + elementName + "\").change(function() { $(\"#" + elementName + "\").css(\"color\", \"#555\"); $(\"#" + elementName + "\").css(\"border\", \"1px solid green\"); });</scrip";
          roleAptSelectScript += "t>";
          $("body").append(roleAptSelectScript)
          elementCounter++;
        }
      	$("#tbody_roletalents").append("<tr><td><i>" + roleTalentArray[roleIndex] + "</i></td></tr>");
        $("#tbody_rolebonus").append("<tr><td><i title='" + roleBonusArray[roleIndex][1] + "'>" + roleBonusArray[roleIndex][0] + "</i></td></tr>"); 
        if(!roleSelected){
          fillSkillPicker();
          fillStatPicker();
          fillTalentPicker_1();
        }
        roleSelected = true;
        if(!$("#div_skillPicker").is(":visible")) {
	         $("#div_skillPicker").toggle();
	         $("#skill_prereq").toggle();
	      }
        if(!$("#div_statPicker").is(":visible")) {
           $("#div_statPicker").toggle();
           $("#stat_prereq").toggle();
        }
      }
      else {
        //$('html, body').animate({
        //  scrollTop: $("#select_bgAptitude").offset().top
        //}, 2000);
        $("#select_bgAptitude").css("border", "1px solid red");
        //alert("Select your background aptitude first.");
        $("#error_bgaptitude").show();
        $("#select_roles>option:eq(0)").attr("selected", true);
      }
    });
});
$("#select_background")
  .change(function() {
    $( "#select_background option:selected" ).each(function() {
      $("#tbody_startingskills").empty();
      $("#tbody_startingtalents").empty();  
      $("#tbody_recroles").empty(); 
      $("#select_roles").empty();
      $("#tbody_startingequip").empty();
      $("#tbody_startingbgbonus").empty();
      $("#aptitude_bg").empty();
      $("#div_bg_aptitude").empty();
      var backgroundIndex = parseInt($(this).val());
      for(var i = 0; i < backgroundSkillsArray[backgroundIndex].length; i++) {
        $("#tbody_startingskills").append("<tr><td><i>" + backgroundSkillsArray[backgroundIndex][i] + "</i></td></tr>");
      }
      for(var i = 0; i < backgroundTalentsArray[backgroundIndex].length; i++) {
        $("#tbody_startingtalents").append("<tr><td><i>" + backgroundTalentsArray[backgroundIndex][i] + "</i></td></tr>");
      }
      var s = '<select id="select_bgAptitude" class="form-control" style="color: red; display: inline; width: 200px;">';
      s += '<option disabled selected>Pick an Aptitude</option>';
      s += '<option value="' + backgroundAptitudesArray[backgroundIndex][0] + '" style=\"color: #555;\">' + aptitudeArray[backgroundAptitudesArray[backgroundIndex][0]] + '</option>';
      s += '<option value="' + backgroundAptitudesArray[backgroundIndex][1] + '" style=\"color: #555;\">' + aptitudeArray[backgroundAptitudesArray[backgroundIndex][1]] + '</option>';
      s += '</select>';
      //$("#aptitude_bg").append(s);
      $("#div_bg_aptitude").append(s);
      $("#div_bg_aptitude").append("&emsp;<b id=\"error_bgaptitude\" style=\"display: none; color: red;\">Select your background aptitude first!</b>");

      var bgAptSelectScript = "<script type=\"text/javascript\">$(\"#select_bgAptitude\").change(function() { $(\"#select_bgAptitude\").css(\"color\", \"#555\"); $(\"#select_bgAptitude\").css(\"border\", \"1px solid green\"); $(\"#error_bgaptitude\").hide(); $(\"#aptitude_bg\").empty(); $(\"#aptitude_bg\").html(\"<i id='aptitude_i_bg'>\" +" + "aptitudeArray[$(\"#select_bgAptitude option:selected\").val()] + " + "\"</i>\"); });</scrip";
      bgAptSelectScript += "t>";
      $("body").append(bgAptSelectScript)
      
      $("#select_roles").append("<option disabled selected>Select Role</option>");
      for(var i = 0; i < rolesListArray.length; i++) {
        var recommended = false;
        for(var j = 0; j < backgroundRecRolesIndexArray[backgroundIndex].length; j++) {
          if(backgroundRecRolesIndexArray[backgroundIndex][j] == i) recommended = true;
        }
        if(recommended) $("#select_roles").append("<option value='" + i + "'>" + rolesListArray[i] + " **</option>");
        else $("#select_roles").append("<option value='" + i + "'>" + rolesListArray[i] + "</option>");
      }
      for(var i = 0; i < beackgroundEquipmentArray[backgroundIndex].length; i++) {
        $("#tbody_startingequip").append("<tr><td><i>" + beackgroundEquipmentArray[backgroundIndex][i] + "</i></td></tr>");
      }
      $("#tbody_startingbgbonus").append("<tr><td><i title='" + backgroundBonusArray[backgroundIndex][1] + "'>" + backgroundBonusArray[backgroundIndex][0] + "</i></td></tr>");
      bgSelected = true;
    });
});

var firstWorldSelect = true;

$("#select_world")
  .change(function() {
    $( "#select_world option:selected" ).each(function() {
      if($("#button_reroll").is(":disabled")){
        $("#button_reroll").attr("disabled", false);
      }
      if($("#button_recalc").is(":disabled")){
        $("#button_recalc").attr("disabled", false);
      }
      if($("#button_applybasepoints").is(":disabled")){
        $("#button_applybasepoints").attr("disabled", false);
      }      
      var worldType = $(this).val();
      resetBgColours();
      rollStats(worldType);
      if(firstWorldSelect) {
	      //generate + apply divination
		  $("#tbody_divination").empty();
		  RollDivination();
		  firstWorldSelect = false;
		  $("#button_divination_reroll").attr("disabled", false);
      $("#button_divination_pick").attr("disabled", false);
	  }
      $("#tbody_startingworldbonus").empty();
      $("#tbody_startingworldbonus").append("<tr><td><i title='" + homeworldBonusArray[parseInt(worldType)][1] + "'>" + homeworldBonusArray[parseInt(worldType)][0] + "</i></td></tr>");
      homeworldSelected = true;
    });
});
  
$("#button_reroll").on("click", function(){
  var worldType = $("#select_world option:selected").val();  
  rollStats(worldType);
});

$("#button_divination_reroll").on("click", function() {
	//generate + apply divination
	$("#tbody_divination").empty();
	RollDivination();
});

$("#button_recalc").on("click", function() {
	ReCalcStats();
});

$("#button_applybasepoints").on("click", function() {
  var basePoints = $("#input_basepoints").val();
  for(var i = 0; i < statsArray.length; i++) {
    $("#box_stat_" + statsArray[i] + "_base").val(basePoints);
  }
  ReCalcStats();
});

function HighLightXPBox(){
  $("#input_exp").css("border", "1px solid red");
  $("#div_noxperror").show();
}

function HideXPErrorBox(){
  $("#input_exp").css("border", "1px solid #ccc");
  $("#div_noxperror").hide();
  $("#div_noxperror_stat").hide();
}

function HighLightStatXPBox(){
  $("#input_exp").css("border", "1px solid red");
  $("#div_noxperror_stat").show();
}

function HideStatXPErrorBox(){
  $("#input_exp").css("border", "1px solid #ccc");
  $("#div_noxperror").hide();
  $("#div_noxperror_stat").hide();
}

function RestoreSkill(index, subIndex){
  var hasSubSection = false;
  if(subIndex > 0) hasSubSection = true;
  if(hasSubSection){
    $("#select_skills option[value='" + index + "_" + subIndex + "']").attr("disabled", false);
  }
  else $("#select_skills option[value='" + index + "']").attr("disabled", false);
}

function RestoreStat(index){
  $("#select_stats option[value='" + index + "']").attr("disabled", false);
}

$("#button_divination_pick").on("click", function() {
  $("#modal_divination").modal("show");
});

$("#button_divination_pick_submit").on("click", function() {
  if($("#select_divination option:selected").val() != "-1"){
    var oldDivIndex = parseInt($("#td_divination").data("div_index"));
    if(oldDivIndex == divinationArray.length-1) {
      var value = parseInt($("#box_stat_fate_base").val());
      $("#box_stat_fate_base").val(value-1);
      ReCalcStats();
    }
    var index = parseInt($("#select_divination option:selected").val());
    $("#tbody_divination").empty();
    $("#tbody_divination").append("<tr><td id=\"td_divination\" data-div_index=\"" + index + "\"><i title='" + divinationArray[index][1] + "'>" + divinationArray[index][0] + "</i></td></tr>");
    if(index == divinationArray.length-1) {
      var value = parseInt($("#box_stat_fate_base").val());
      $("#box_stat_fate_base").val(value+1);
      ReCalcStats();
    }
    $("#modal_divination").modal("hide");
  }
});

/////////////////////////////////
//GET IMAGE FUNCTIONS FOR jsPDF //
/////////////////////////////////
var getImageFromUrl = function(url, callback) {
  var img = new Image, data, ret={data: null, pending: true};
  
  img.onError = function() {
    throw new Error('Cannot load image: "'+url+'"');
  }
  img.onload = function() {
    var canvas = document.createElement('canvas');
    document.body.appendChild(canvas);
    canvas.width = img.width;
    canvas.height = img.height;

    var ctx = canvas.getContext('2d');
    ctx.drawImage(img, 0, 0);
    // Grab the image as a jpeg encoded in base64, but only the data
    data = canvas.toDataURL('image/jpeg').slice('data:image/jpeg;base64,'.length);
    
    // Convert the data to binary form
    data = atob(data)
    document.body.removeChild(canvas);

    ret['data'] = data;
    ret['pending'] = false;
    if (typeof callback === 'function') {
      callback(data);
    }
  }
  img.src = url;

  return ret;
}
	//////////////////////////////////
	//////////////////////////////////

	var doc = new jsPDF();
	var marginTop = 14;
	var marginLeft = 14;
	var lineSpacing = 5;
	var underlineWidth = 0.25;

	$("#button_testpdf").on("click", function(){
		doc = new jsPDF(); //reset doc
		doc.setFontSize(12);
		doc.setLineWidth(underlineWidth);

	///////////////////////////////////////////////////
	// Add field names in standard text & underlines //
	///////////////////////////////////////////////////
	//character name
	//doc.text(marginLeft, marginTop, 'Character Name:');  
	//doc.line(marginLeft+35, (marginTop+1), 95, (marginTop+1));
	//homeworld
	//doc.text(marginLeft, marginTop+lineSpacing, 'Homeworld:');
	//doc.line(marginLeft+25, (marginTop+1)+lineSpacing, 95, (marginTop+1)+lineSpacing);
	//background

	//role

  
  getImageFromUrl('http://heresycreator.96.lt/pcsheet1-200ppi.jpg', AddPCSheetImg);
	// if($("#radio_print_sheet").prop("checked")) getImageFromUrl('http://heresycreator.96.lt/pcsheet1-200ppi.jpg', AddPCSheetImg);
	// else getImageFromUrl('http://heresycreator.96.lt/DH-icon.jpeg', AddImage);  
  
})

function AddImage(imgData){
  doc.addImage(imgData, 'JPEG', 95, 10, 35, 60); 
  doc.output("dataurlnewwindow");
}

function AddPCSheetImg(imgData){
	var w = 210;
	var h = 300;
	doc.addImage(imgData, 'JPEG', 0, 0, w, h);	

	AddFieldText();
}

var yPos_stat2 = 0;

function AddFieldText(){
	////////////////////////////////////////
	// Add field values in 'Times' italic //
	////////////////////////////////////////
	doc.setFont("times");
	doc.setFontType("italic");
	//character name  
	doc.text(marginLeft+26, marginTop, $("#box_name").val())
	//homeworld
	if($("#select_world").val() != null) doc.text(marginLeft+20, marginTop+lineSpacing, $("#select_world option:selected").html().split("(")[0]);
	//background
	if($("#select_background").val() != null) doc.text(marginLeft+19, marginTop+(lineSpacing*2), $("#select_background option:selected").html());
	//role
	if($("#select_roles").val() != null) doc.text(marginLeft+9, marginTop+(lineSpacing*3), $("#select_roles option:selected").html().split("*")[0]);
	//elite advances
	
	//divination
	if($("#td_divination i").html() != null) doc.text(marginLeft+16, marginTop+(lineSpacing*5), $("#td_divination i").html());	
	//notes

  //Draw Gender
  if($("#radio_gender_male").prop("checked")) doc.text(137, marginTop+(lineSpacing), "Male");
  else doc.text(137, marginTop+(lineSpacing), "Female");

  //CHARACTER STATS
  if(roleSelected){
    doc.setFontSize(30);
    //doc.setFont("courier");
    doc.setFontType("normal");
    //Weapon Skill
    var digit1 = Math.floor(parseInt($("#box_stat_ws_total").val())/10);
    var digit2 = parseInt($("#box_stat_ws_total").val())%10;
    doc.text(marginLeft+17, marginTop+(lineSpacing*12.5), digit1.toString());
    doc.text(marginLeft+25, marginTop+(lineSpacing*12.5), digit2.toString());
    //Intelligence
    digit1 = Math.floor(parseInt($("#box_stat_int_total").val())/10);
    digit2 = parseInt($("#box_stat_int_total").val())%10;
    doc.text(marginLeft+50, marginTop+(lineSpacing*12.5), digit1.toString());
    doc.text(marginLeft+58, marginTop+(lineSpacing*12.5), digit2.toString());

    //Ballistic Skill
    digit1 = Math.floor(parseInt($("#box_stat_bs_total").val())/10);
    digit2 = parseInt($("#box_stat_bs_total").val())%10;
    doc.text(marginLeft+17, marginTop+(lineSpacing*16.1), digit1.toString());
    doc.text(marginLeft+25, marginTop+(lineSpacing*16.1), digit2.toString());
    //Perception
    digit1 = Math.floor(parseInt($("#box_stat_per_total").val())/10);
    digit2 = parseInt($("#box_stat_per_total").val())%10;
    doc.text(marginLeft+50, marginTop+(lineSpacing*16.1), digit1.toString());
    doc.text(marginLeft+58, marginTop+(lineSpacing*16.1), digit2.toString());

    //Strength
    digit1 = Math.floor(parseInt($("#box_stat_s_total").val())/10);
    digit2 = parseInt($("#box_stat_s_total").val())%10;
    doc.text(marginLeft+17, marginTop+(lineSpacing*19.8), digit1.toString());
    doc.text(marginLeft+25, marginTop+(lineSpacing*19.8), digit2.toString());
    //Willpower
    digit1 = Math.floor(parseInt($("#box_stat_wp_total").val())/10);
    digit2 = parseInt($("#box_stat_wp_total").val())%10;
    doc.text(marginLeft+50, marginTop+(lineSpacing*19.8), digit1.toString());
    doc.text(marginLeft+58, marginTop+(lineSpacing*19.8), digit2.toString());

    //Toughness
    digit1 = Math.floor(parseInt($("#box_stat_t_total").val())/10);
    digit2 = parseInt($("#box_stat_t_total").val())%10;
    doc.text(marginLeft+17, marginTop+(lineSpacing*23.2), digit1.toString());
    doc.text(marginLeft+25, marginTop+(lineSpacing*23.2), digit2.toString());
    //Fellowship
    digit1 = Math.floor(parseInt($("#box_stat_fel_total").val())/10);
    digit2 = parseInt($("#box_stat_fel_total").val())%10;
    doc.text(marginLeft+50, marginTop+(lineSpacing*23.2), digit1.toString());
    doc.text(marginLeft+58, marginTop+(lineSpacing*23.2), digit2.toString());

    //Agility
    digit1 = Math.floor(parseInt($("#box_stat_ag_total").val())/10);
    digit2 = parseInt($("#box_stat_ag_total").val())%10;
    doc.text(marginLeft+17, marginTop+(lineSpacing*26.8), digit1.toString());
    doc.text(marginLeft+25, marginTop+(lineSpacing*26.8), digit2.toString());
    //Influence
    digit1 = Math.floor(parseInt($("#box_stat_infl_total").val())/10);
    digit2 = parseInt($("#box_stat_infl_total").val())%10;
    doc.text(marginLeft+50, marginTop+(lineSpacing*26.8), digit1.toString());
    doc.text(marginLeft+58, marginTop+(lineSpacing*26.8), digit2.toString());
  }

  //APTITUDES
  doc.setFontSize(12);
  doc.setFont("times");
  doc.setFontType("italic");
  if(homeworldSelected){
    doc.text(marginLeft, marginTop+(lineSpacing*50.5), $("#aptitude_i_world").html());
  }
  if(bgSelected){
    doc.text(marginLeft, marginTop+(lineSpacing*51.4), $("#aptitude_i_bg").html());
  }
  if(roleSelected){
    var spacingVal = 0.9;

    for(var i = 0; i < 5; i++){
      var offset = (i + 2);
      if(i < 4) var xOffset = 0;
      else {
        xOffset = 43;
        spacingVal = 0;
      }
      if($("#role_apt_" + i).val() != null){
        doc.text(marginLeft+xOffset, marginTop+(lineSpacing*(50.5+(offset*spacingVal))), $("#role_apt_" + i).html());
      }
      else{
        if($("#select_role_apt_" + i +" option:selected").val() != "CHOICE! Pick a Stat" || $("#select_role_apt_" + i +" option:selected").val() != "CLASH! Pick a Stat"){
          doc.text(marginLeft+xOffset, marginTop+(lineSpacing*(50.5+(offset*spacingVal))), $("#select_role_apt_" + i +" option:selected").val());
        }
      }
    }
  }

  ///////////////////////
  // DRAW SKILL LEVELS //
  ///////////////////////
  var sqW = 2;
  doc.setDrawColor(0);
  doc.setFillColor(0);
  var subSkillCounter = 0;
  var forbiddenSkillCounter = 0;
  var linguisticsSkillCounter = 0;
  var scholasticSkillCounter = 0;
  var tradeSkillCounter = 0;
  var doNotDraw = false;

  $("#tbody_skills tr").each( function(){ 
    doNotDraw = false;
    var n = $(this).attr("id");
    var rowId = n.split("_")[2];
    var skill = $("#" + n + "_td_name").html();
    var subSkill = skill.split("-");
    var subSkillParent = subSkill[0];
    
    var parentName = subSkillParent.split(" ");
    var actualParentName = parentName[0];
    for(var i = 1; i < parentName.length; i++){
      if(parentName[i] != "" && parentName[i] != " "){
        actualParentName += " ";
        actualParentName += parentName[i];
      }
    }

    var isSubSkill = false;    
    if(subSkill.length > 1){
      switch(actualParentName){
        case "Common Lore":
          if(subSkillCounter < 4) {
            isSubSkill = true;
            subSkillCounter++;
            subSkill = subSkill[1].slice(1);
          }
          break;
        case "Forbidden Lore":
          if(forbiddenSkillCounter < 4) {
            isSubSkill = true;
            forbiddenSkillCounter++;
            subSkill = subSkill[1].slice(1);
          }
          break;
        case "Linguistics":
          if(linguisticsSkillCounter < 2) {
            isSubSkill = true;
            linguisticsSkillCounter++;
            subSkill = subSkill[1].slice(1);
          }
          break;
        case "Scholastic Lore":
          if(scholasticSkillCounter < 5) {
            isSubSkill = true;
            scholasticSkillCounter++;
            subSkill = subSkill[1].slice(1);
          }
          break;
        case "Trade":
          if(tradeSkillCounter < 3) {
            isSubSkill = true;
            tradeSkillCounter++;
            subSkill = subSkill[1].slice(1);
          }
          break;
        case "Navigate":
          isSubSkill = true;
          subSkill = subSkill[1].slice(1);
          break;
        case "Operate":
          isSubSkill = true;
          subSkill = subSkill[1].slice(1);
          break;
      }
      if(isSubSkill == false) doNotDraw = true;
      
    }
    else if(subSkill.length > 1) doNotDraw = true;
    
    var yPos = 0;
    var xSkillOffset = 48;
    var rightColumn = false;
    var rightColumnLower = false;
    var additionalFudge = 0;
    
    var xPos_Known = 134.4;
    var xPos_Trained = 139;
    var xPos_Exp = 143.6;
    var xPos_Expert = 148.2;

    switch(skill) {
      case "Acrobatics":
        yPos = marginTop+60.7;
        break;
      case "Athletics":
        yPos = marginTop+65.5;
        break;
      case "Awareness":
        yPos = marginTop+70.4;
        break;
      case "Charm":
        yPos = marginTop+75.3;
        break;
      case "Command":
        yPos = marginTop+80.1;
        break;
      case "Commerce":
        yPos = marginTop+84.9;
        break;
      case "Deceive":
        yPos = marginTop+113.5;
        break;
      //Common Lore
      case "Dodge":
        yPos = marginTop+118.5;
        break;
      //Forbidden Lore
      case "Inquiry":
        yPos = marginTop+147.7;
        break;
      case "Interrogation":
        yPos = marginTop+152.6;
        break;
      case "Intimidate":
        yPos = marginTop+157.5;
        break;
      //Linguistics
      case "Logic":
        yPos = marginTop+176.2;
        break;

      //2nd Column
      //
      case "Medicae":
        rightColumn = true;
        yPos = marginTop+60.8;
        break;
      //Navigate!
      //Operate!
      case "Parry":
        rightColumn = true;
        yPos = marginTop+94.8;
        break;
      case "Psyniscience":
        rightColumn = true;
        yPos = marginTop+99.6;
        break;
      //Scholastic Lore
      case "Scrutiny":
        yPos = marginTop+133.2;
        rightColumnLower = true;
        break;
      case "Security":
        yPos = marginTop+138.0;
        rightColumnLower = true;
        break;
      case "Sleight of Hand":
        yPos = marginTop+142.9;
        rightColumnLower = true;
        break;
      case "Stealth":
        yPos = marginTop+147.77;
        rightColumnLower = true;
        break;
      case "Survival":
        yPos = marginTop+152.6;
        rightColumnLower = true;
        break;
      case "Tech-Use":
        yPos = marginTop+156.95;
        rightColumnLower = true;
        additionalFudge = -0.2;
        break;
      //Trade
    }

    if(rightColumn) {
      xPos_Known = 134.75+xSkillOffset;
      xPos_Trained = 138.95+xSkillOffset;
      xPos_Exp = 143.3+xSkillOffset;
      xPos_Expert = 147.8+xSkillOffset;
    }
    if(rightColumnLower) {
      xPos_Known = 134.2+xSkillOffset+additionalFudge;
      xPos_Trained = 138.94+xSkillOffset+additionalFudge;
      xPos_Exp = 143.5+xSkillOffset+additionalFudge;
      xPos_Expert = 148.3+xSkillOffset+additionalFudge;
    } 

    if(isSubSkill){  
      var subSkillNameXPos = 108.5;
      var subSkillNameYPos = 0;
      switch(actualParentName){
        case "Common Lore":
          if(subSkillCounter == 1) yPos = marginTop+89.8+(4.9*subSkillCounter);          
          else yPos = marginTop+89.8+(4.9*subSkillCounter)+(-0.04*subSkillCounter);
          subSkillNameYPos = (lineSpacing*subSkillCounter); //for title printing
          break;
        case "Forbidden Lore":
          if(forbiddenSkillCounter == 1) yPos = marginTop+123.29+(4.9*forbiddenSkillCounter);
          else yPos = marginTop+123.29+(4.9*forbiddenSkillCounter)+(-0.04*forbiddenSkillCounter);
          subSkillNameYPos = (lineSpacing*forbiddenSkillCounter)+33.5; //for title printing
          break;
        case "Linguistics":
          break;
        case "Navigate":
          rightColumn = true;
          if(subSkill == "Surface");
          if(subSkill == "Stellar");
          if(subSkill == "Warp");
          break;
        case "Operate":
          if(subSkill == "Aeronautica");
          if(subSkill == "Stellar");
          if(subSkill == "Voidship");
          break;
        case "Scholastic Lore":
          rightColumnLower = true;
          subSkillNameXPos = 158.5;
          break;
        case "Trade":
          rightColumnLower = true;
          subSkillNameXPos = 158.5;
          break;
      }

      if(rightColumn) {
      xPos_Known = 134.75+xSkillOffset;
      xPos_Trained = 138.95+xSkillOffset;
      xPos_Exp = 143.3+xSkillOffset;
      xPos_Expert = 147.8+xSkillOffset;
      }
      if(rightColumnLower) {
        xPos_Known = 134.2+xSkillOffset+additionalFudge;
        xPos_Trained = 138.94+xSkillOffset+additionalFudge;
        xPos_Exp = 143.5+xSkillOffset+additionalFudge;
        xPos_Expert = 148.3+xSkillOffset+additionalFudge;
      }
    }
    if(HasSkillKnown(rowId) && doNotDraw == false){
      if(isSubSkill) {
        doc.setFontSize(8);
        doc.text(subSkillNameXPos, marginTop+92+subSkillNameYPos, subSkill);
      }
      doc.rect(xPos_Known, yPos, sqW, sqW, 'F');
      if(HasSkillTrained(rowId)){
        doc.rect(xPos_Trained, yPos, sqW, sqW, 'F');
        if(HasSkillExperienced(rowId)){
          doc.rect(xPos_Exp, yPos, sqW, sqW, 'F');
          if(HasSkillExpert(rowId)){
          doc.rect(xPos_Expert, yPos, sqW, sqW, 'F');
          }
        }
      }
    }
  });

  //draw attribute levels
  $("#tbody_stats tr").each( function(){
    var n = $(this).attr("id");
    var rowId = n.split("_")[2];
    var stat = $("#" + n + "_td_name").html();

    var yPos_stat = 0;
    var xPos = 0;
    var circle_gap = 2.4;
    var stat_gap = 18.15;
    
    var xPos_basic_left = 47.45;
    var xPos_basic_right = 59.85;

    doc.setFillColor(0, 0, 0);
    switch(stat) {
      case "Weapon Skill":
        if($("#checkbox_stat_" + rowId + "_1").prop("checked")){
          yPos_stat = 69.8;
          xPos = xPos_basic_left;
          doc.ellipse(xPos, yPos_stat, 0.8, 0.8, 'F');
        }
        if($("#checkbox_stat_" + rowId + "_2").prop("checked")){
          yPos_stat = 72.2;
          xPos = xPos_basic_left;
          doc.ellipse(xPos, yPos_stat, 0.8, 0.8, 'F');
        }
        if($("#checkbox_stat_" + rowId + "_3").prop("checked")){
          yPos_stat = 74.6;
          xPos = xPos_basic_left;
          doc.ellipse(xPos, yPos_stat, 0.8, 0.8, 'F');
        }
        if($("#checkbox_stat_" + rowId + "_4").prop("checked")){
          yPos_stat = 77;
          xPos = xPos_basic_left;
          doc.ellipse(xPos, yPos_stat, 0.8, 0.8, 'F');
        }
        if($("#checkbox_stat_" + rowId + "_5").prop("checked")){
          yPos_stat = 69.8;
          xPos = xPos_basic_left + 1.8;
          doc.ellipse(xPos, yPos_stat, 0.8, 0.8, 'F');
        }        
        break;
      case "Ballistic Skill":
        if($("#checkbox_stat_" + rowId + "_1").prop("checked")){
          yPos_stat = 87.65;
          xPos = xPos_basic_left;
          doc.ellipse(xPos, yPos_stat, 0.8, 0.8, 'F');
        }
        if($("#checkbox_stat_" + rowId + "_2").prop("checked")){
          yPos_stat = 90.05;
          xPos = xPos_basic_left;
          doc.ellipse(xPos, yPos_stat, 0.8, 0.8, 'F');
        }
        if($("#checkbox_stat_" + rowId + "_3").prop("checked")){
          yPos_stat = 92.45;
          xPos = xPos_basic_left;
          doc.ellipse(xPos, yPos_stat, 0.8, 0.8, 'F');
        }
        if($("#checkbox_stat_" + rowId + "_4").prop("checked")){
          yPos_stat = 94.85;
          xPos = xPos_basic_left;
          doc.ellipse(xPos, yPos_stat, 0.8, 0.8, 'F');
        }
        if($("#checkbox_stat_" + rowId + "_5").prop("checked")){
          yPos_stat = 87.65;
          xPos = xPos_basic_left + 1.8;
          doc.ellipse(xPos, yPos_stat, 0.8, 0.8, 'F');
        }        
        break;
      case "Strength":
        if($("#checkbox_stat_" + rowId + "_1").prop("checked")){
          yPos_stat = 87.65 + stat_gap;
          xPos = xPos_basic_left;
          doc.ellipse(xPos, yPos_stat, 0.8, 0.8, 'F');
        }
        if($("#checkbox_stat_" + rowId + "_2").prop("checked")){
          yPos_stat = 90.05 + stat_gap;
          xPos = xPos_basic_left;
          doc.ellipse(xPos, yPos_stat, 0.8, 0.8, 'F');
        }
        if($("#checkbox_stat_" + rowId + "_3").prop("checked")){
          yPos_stat = 92.45 + stat_gap;
          xPos = xPos_basic_left;
          doc.ellipse(xPos, yPos_stat, 0.8, 0.8, 'F');
        }
        if($("#checkbox_stat_" + rowId + "_4").prop("checked")){
          yPos_stat = 94.85 + stat_gap;
          xPos = xPos_basic_left;
          doc.ellipse(xPos, yPos_stat, 0.8, 0.8, 'F');
        }
        if($("#checkbox_stat_" + rowId + "_5").prop("checked")){
          yPos_stat = 87.65 + stat_gap;
          xPos = xPos_basic_left + 1.8;
          doc.ellipse(xPos, yPos_stat, 0.8, 0.8, 'F');
        }        
        break;
      case "Toughness":
        if($("#checkbox_stat_" + rowId + "_1").prop("checked")){
          yPos_stat = 123.36;
          xPos = xPos_basic_left;
          doc.ellipse(xPos, yPos_stat, 0.8, 0.8, 'F');
        }
        if($("#checkbox_stat_" + rowId + "_2").prop("checked")){
          yPos_stat = 123.36 + circle_gap;
          xPos = xPos_basic_left;
          doc.ellipse(xPos, yPos_stat, 0.8, 0.8, 'F');
        }
        if($("#checkbox_stat_" + rowId + "_3").prop("checked")){
          yPos_stat = 123.36 + circle_gap*2;
          xPos = xPos_basic_left;
          doc.ellipse(xPos, yPos_stat, 0.8, 0.8, 'F');
        }
        if($("#checkbox_stat_" + rowId + "_4").prop("checked")){
          yPos_stat = 123.36 + circle_gap*3;
          xPos = xPos_basic_left;
          doc.ellipse(xPos, yPos_stat, 0.8, 0.8, 'F');
        }
        if($("#checkbox_stat_" + rowId + "_5").prop("checked")){
          yPos_stat = 123.36;
          xPos = xPos_basic_left + 1.8;
          doc.ellipse(xPos, yPos_stat, 0.8, 0.8, 'F');
        }        
        break;
      case "Agility":
        if($("#checkbox_stat_" + rowId + "_1").prop("checked")){
          yPos_stat = 141.16;
          xPos = xPos_basic_left;
          doc.ellipse(xPos, yPos_stat, 0.8, 0.8, 'F');
        }
        if($("#checkbox_stat_" + rowId + "_2").prop("checked")){
          yPos_stat = 141.16 + circle_gap;
          xPos = xPos_basic_left;
          doc.ellipse(xPos, yPos_stat, 0.8, 0.8, 'F');
        }
        if($("#checkbox_stat_" + rowId + "_3").prop("checked")){
          yPos_stat = 141.16 + circle_gap*2;
          xPos = xPos_basic_left;
          doc.ellipse(xPos, yPos_stat, 0.8, 0.8, 'F');
        }
        if($("#checkbox_stat_" + rowId + "_4").prop("checked")){
          yPos_stat = 141.16 + circle_gap*3;
          xPos = xPos_basic_left;
          doc.ellipse(xPos, yPos_stat, 0.8, 0.8, 'F');
        }
        if($("#checkbox_stat_" + rowId + "_5").prop("checked")){
          yPos_stat = 141.16;
          xPos = xPos_basic_left + 1.8;
          doc.ellipse(xPos, yPos_stat, 0.8, 0.8, 'F');
        }        
        break;
      //////////////////////
      //// RIGHT COLUMN ////
      //////////////////////
      case "Intelligence":
        if($("#checkbox_stat_" + rowId + "_1").prop("checked")){
          yPos_stat = 69.8;
          doc.ellipse(xPos_basic_right, yPos_stat, 0.8, 0.8, 'F');
        }
        if($("#checkbox_stat_" + rowId + "_2").prop("checked")){
          yPos_stat = 72.25;
          doc.ellipse(xPos_basic_right, yPos_stat, 0.8, 0.8, 'F');
        }
        if($("#checkbox_stat_" + rowId + "_3").prop("checked")){
          yPos_stat = 74.65;
          doc.ellipse(xPos_basic_right, yPos_stat, 0.8, 0.8, 'F');
        }
        if($("#checkbox_stat_" + rowId + "_4").prop("checked")){
          yPos_stat = 77.05;
          doc.ellipse(xPos_basic_right, yPos_stat, 0.8, 0.8, 'F');
        }
        if($("#checkbox_stat_" + rowId + "_5").prop("checked")){
          yPos_stat = 69.8;
          doc.ellipse(xPos_basic_right-1.8, yPos_stat, 0.8, 0.8, 'F');
        }        
        break;
      case "Perception":
        if($("#checkbox_stat_" + rowId + "_1").prop("checked")){
          yPos_stat = 87.65;
          doc.ellipse(xPos_basic_right, yPos_stat, 0.8, 0.8, 'F');
        }
        if($("#checkbox_stat_" + rowId + "_2").prop("checked")){
          yPos_stat = 90.05;
          doc.ellipse(xPos_basic_right, yPos_stat, 0.8, 0.8, 'F');
        }
        if($("#checkbox_stat_" + rowId + "_3").prop("checked")){
          yPos_stat = 92.5;
          doc.ellipse(xPos_basic_right, yPos_stat, 0.8, 0.8, 'F');
        }
        if($("#checkbox_stat_" + rowId + "_4").prop("checked")){
          yPos_stat = 94.9;
          doc.ellipse(xPos_basic_right, yPos_stat, 0.8, 0.8, 'F');
        }
        if($("#checkbox_stat_" + rowId + "_5").prop("checked")){
          yPos_stat = 87.65;
          doc.ellipse(xPos_basic_right-1.8, yPos_stat, 0.8, 0.8, 'F');
        }        
        break;
      case "Willpower":
        if($("#checkbox_stat_" + rowId + "_1").prop("checked")){
          yPos_stat = 87.65 + stat_gap;
          doc.ellipse(xPos_basic_right, yPos_stat, 0.8, 0.8, 'F');
        }
        if($("#checkbox_stat_" + rowId + "_2").prop("checked")){
          yPos_stat = 90.05 + stat_gap;
          doc.ellipse(xPos_basic_right, yPos_stat, 0.8, 0.8, 'F');
        }
        if($("#checkbox_stat_" + rowId + "_3").prop("checked")){
          yPos_stat = 92.5 + stat_gap;
          doc.ellipse(xPos_basic_right, yPos_stat, 0.8, 0.8, 'F');
        }
        if($("#checkbox_stat_" + rowId + "_4").prop("checked")){
          yPos_stat = 94.9 + stat_gap;
          doc.ellipse(xPos_basic_right, yPos_stat, 0.8, 0.8, 'F');
        }
        if($("#checkbox_stat_" + rowId + "_5").prop("checked")){
          yPos_stat = 87.65 + stat_gap;
          doc.ellipse(xPos_basic_right-1.8, yPos_stat, 0.8, 0.8, 'F');
        }        
        break;
      case "Fellowship":
        if($("#checkbox_stat_" + rowId + "_1").prop("checked")){
          yPos_stat = 123.36;
          doc.ellipse(xPos_basic_right, yPos_stat, 0.8, 0.8, 'F');
        }
        if($("#checkbox_stat_" + rowId + "_2").prop("checked")){
          yPos_stat = 123.36 + circle_gap;
          doc.ellipse(xPos_basic_right, yPos_stat, 0.8, 0.8, 'F');
        }
        if($("#checkbox_stat_" + rowId + "_3").prop("checked")){
          yPos_stat = 123.41 + circle_gap*2;
          doc.ellipse(xPos_basic_right, yPos_stat, 0.8, 0.8, 'F');
        }
        if($("#checkbox_stat_" + rowId + "_4").prop("checked")){
          yPos_stat = 123.41 + circle_gap*3;
          doc.ellipse(xPos_basic_right, yPos_stat, 0.8, 0.8, 'F');
        }
        if($("#checkbox_stat_" + rowId + "_5").prop("checked")){
          yPos_stat = 123.36;
          doc.ellipse(xPos_basic_right-1.8, yPos_stat, 0.8, 0.8, 'F');
        }        
        break;
    }

  });

  CompleteDocument();
}

function CompleteDocument(){
	doc.output("dataurlnewwindow");
}

//skill checkbox test methods
function HasSkillKnown(rowId){
  return $("#checkbox_" + rowId + "_1").prop("checked");
}

function HasSkillTrained(rowId){
  return $("#checkbox_" + rowId + "_2").prop("checked");
}

function HasSkillExperienced(rowId){
  return $("#checkbox_" + rowId + "_3").prop("checked");
}

function HasSkillExpert(rowId){
  return $("#checkbox_" + rowId + "_4").prop("checked");
}

///////////////////////////////////////////
// METHODS TO SAVE & LOAD CHARACTER DATA //
///////////////////////////////////////////

//SAVING

$("#button_save").on("click", function(){ 
  $("#button_savemodal_submit").prop("disabled", true);   
  var name = $("#box_name").val();
  if(name != null && name != "") $("#button_savemodal_submit").prop("disabled", false);
  $("#input_savemodal_char_name").val(name);
  $("#modal_save").modal("show");
});

$("#button_savemodal_submit").on("click", function(){ 
  var name = $("#input_savemodal_char_name").val();
  var pin = $("#input_savemodal_pin").val();
  if((name != null && name != "") && (pin != null && pin != "")){
    //actually save character data
  }
});

//LOADING

$("#button_load").on("click", function(){
  var xmlhttp = new XMLHttpRequest();
  xmlhttp.onreadystatechange=function() {
    if (xmlhttp.readyState==4 && xmlhttp.status==200) {
      var data = JSON.parse(xmlhttp.responseText); //id, gender, name, homeworld, bg, role, bg_aptitude, divination
      console.log(data);
      LoadCharacterData(data);
    }
  }
  xmlhttp.open("GET","http://heresycreator.96.lt/fetchChar.php?q=1",true);
  xmlhttp.send();
});


function LoadCharacterData(data){
  //set gender
  if(data.gender == "male") $("#radio_gender_male").prop("checked", "checked");
  else $("#radio_gender_female").prop("checked", "checked");
  //set name
  if(data.name != null && data.name != "") $("#box_name").val(data.name);
  //set homeworld
  if(data.homeworld > -1) $("#select_world").val(data.homeworld).change();
  //set background
  if(data.background > -1) $("#select_background").val(data.background).change();
  //set background aptitude
  if(data.bg_aptitude > -1) $("#select_bgAptitude").val(data.bg_aptitude).change();
  //set role
  if(data.role > -1) $("#select_roles").val(data.role).change();
  //set assassin role aptitude
  if(data.role == 0 && data.assassin_role_apt != null && data.assassin_role_apt != "") $("#select_role_apt_1").val(data.assassin_role_apt).change();
  //////////////////////

  //set base stat points
  if(data.base_stat_points > 20) {
    $("#input_basepoints").val(data.base_stat_points);
    var basePoints = data.base_stat_points;
    for(var i = 0; i < statsArray.length; i++) {
      $("#box_stat_" + statsArray[i] + "_base").val(basePoints);
    }
  }
  //set weapon skill rolls
  if(data.stat_ws_1 > -1) $("#box_stat_ws_roll1").val(data.stat_ws_1);
  if(data.stat_ws_2 > -1) $("#box_stat_ws_roll2").val(data.stat_ws_2);
  //set ballistic skill rolls
  if(data.stat_bs_1 > -1) $("#box_stat_bs_roll1").val(data.stat_bs_1);
  if(data.stat_bs_2 > -1) $("#box_stat_bs_roll2").val(data.stat_bs_2);
  //set strength rolls
  if(data.stat_s_1 > -1) $("#box_stat_s_roll1").val(data.stat_s_1);
  if(data.stat_s_2 > -1) $("#box_stat_s_roll2").val(data.stat_s_2);
  //set toughness rolls
  if(data.stat_t_1 > -1) $("#box_stat_t_roll1").val(data.stat_t_1);
  if(data.stat_t_2 > -1) $("#box_stat_t_roll2").val(data.stat_t_2);
  //set agility rolls
  if(data.stat_ag_1 > -1) $("#box_stat_ag_roll1").val(data.stat_ag_1);
  if(data.stat_ag_2 > -1) $("#box_stat_ag_roll2").val(data.stat_ag_2);
  //set intelligence rolls
  if(data.stat_int_1 > -1) $("#box_stat_int_roll1").val(data.stat_int_1);
  if(data.stat_int_2 > -1) $("#box_stat_int_roll2").val(data.stat_int_2);
  //set percetion rolls
  if(data.stat_per_1 > -1) $("#box_stat_per_roll1").val(data.stat_per_1);
  if(data.stat_per_2 > -1) $("#box_stat_per_roll2").val(data.stat_per_2);
  //set willpower rolls
  if(data.stat_wil_1 > -1) $("#box_stat_wp_roll1").val(data.stat_wil_1);
  if(data.stat_wil_2 > -1) $("#box_stat_wp_roll2").val(data.stat_wil_2);
  //set fellowship rolls
  if(data.stat_fel_1 > -1) $("#box_stat_fel_roll1").val(data.stat_fel_1);
  if(data.stat_fel_2 > -1) $("#box_stat_fel_roll2").val(data.stat_fel_2);
  //set influence rolls
  if(data.stat_infl_1 > -1) $("#box_stat_infl_roll1").val(data.stat_infl_1);
  if(data.stat_infl_2 > -1) $("#box_stat_infl_roll2").val(data.stat_infl_2);
  //set wounds roll
  if(data.stat_wounds > -1) $("#box_stat_wounds_roll1").val(data.stat_wounds);
  //set fate points roll
  if(data.stat_fatepoints > -1) $("#box_stat_fate_roll1").val(data.stat_fatepoints);
  ////////////////////
  // RECALC ALL STATS!
  ReCalcStats();
  ////////////////////

  //load skills

  //TODO

  //load stat advances

  //TODO

};

</script>
</html>



